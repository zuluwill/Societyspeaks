openapi: 3.0.3
info:
  title: Society Speaks Partner API
  description: |
    Integrate Society Speaks on your site. Look up discussions by article URL,
    get participation snapshots, and embed the voting widget.
    All endpoints return JSON. See the [Partner Hub](.) for full documentation.
  version: 1.0.0
  contact:
    name: Society Speaks
    url: https://societyspeaks.io

servers:
  - url: /
    description: Same origin (use when trying from API Playground)

paths:
  /api/discussions/by-article-url:
    get:
      summary: Lookup by article URL
      description: Find a discussion by the URL of your article. Returns embed, consensus, and snapshot URLs.
      operationId: lookupByArticleUrl
      parameters:
        - name: url
          in: query
          required: true
          description: The article URL (URL-encoded)
          schema:
            type: string
            example: "https://example.com/article"
        - name: ref
          in: query
          required: false
          description: Partner reference for analytics
          schema:
            type: string
        - name: X-API-Key
          in: header
          required: false
          description: Partner test/live API key (required for test environment access)
          schema:
            type: string
      responses:
        '200':
          description: Discussion found
          content:
            application/json:
              schema:
                type: object
                properties:
                  discussion_id:
                    type: integer
                  slug:
                    type: string
                  title:
                    type: string
                  embed_url:
                    type: string
                    format: uri
                  consensus_url:
                    type: string
                    format: uri
                  snapshot_url:
                    type: string
                    format: uri
                  source:
                    type: string
                    enum: [rss, partner]
                  env:
                    type: string
                    enum: [test, live]
        '400':
          description: Invalid or missing URL
        '403':
          description: Embed and API access revoked for this partner ref
        '404':
          description: No discussion found for this URL
        '429':
          description: Too many requests; includes Retry-After header
          headers:
            Retry-After:
              description: Seconds until the next request is allowed
              schema:
                type: integer
                example: 60

  /api/discussions/{discussion_id}/snapshot:
    get:
      summary: Get discussion snapshot
      description: Get participation counts and metadata. Does not include analysis content.
      operationId: getSnapshot
      parameters:
        - name: discussion_id
          in: path
          required: true
          schema:
            type: integer
        - name: ref
          in: query
          required: false
          schema:
            type: string
        - name: X-API-Key
          in: header
          required: false
          description: Partner test/live API key (required for test environment access)
          schema:
            type: string
      responses:
        '200':
          description: Snapshot data
          content:
            application/json:
              schema:
                type: object
                properties:
                  discussion_id:
                    type: integer
                  discussion_title:
                    type: string
                  participant_count:
                    type: integer
                  statement_count:
                    type: integer
                  has_analysis:
                    type: boolean
                  consensus_url:
                    type: string
                    format: uri
                  env:
                    type: string
                    enum: [test, live]
                  opinion_groups:
                    type: integer
                    description: Present when has_analysis is true
                  analyzed_at:
                    type: string
                    format: date-time
                  teaser_text:
                    type: string
        '403':
          description: Partner disabled or test discussion requires valid test API key
        '404':
          description: Discussion not found
        '429':
          description: Too many requests; includes Retry-After header
          headers:
            Retry-After:
              description: Seconds until the next request is allowed
              schema:
                type: integer
                example: 60

  /api/oembed:
    get:
      summary: oEmbed provider
      description: Returns oEmbed JSON for Society Speaks discussion URLs (for platforms that support oEmbed).
      operationId: getOembed
      parameters:
        - name: url
          in: query
          required: true
          description: Society Speaks discussion or consensus URL
          schema:
            type: string
            format: uri
        - name: maxwidth
          in: query
          schema:
            type: integer
        - name: maxheight
          in: query
          schema:
            type: integer
        - name: format
          in: query
          schema:
            type: string
            enum: [json]
            default: json
      responses:
        '200':
          description: oEmbed response
          content:
            application/json:
              schema:
                type: object
                properties:
                  type:
                    type: string
                    example: "rich"
                  version:
                    type: string
                  title:
                    type: string
                  provider_name:
                    type: string
                  html:
                    type: string
                  width:
                    type: integer
                  height:
                    type: integer
                  cache_age:
                    type: integer
                    description: Recommended cache duration in seconds
                    example: 3600
        '400':
          description: Invalid URL
        '404':
          description: Discussion not found
        '501':
          description: Unsupported format (only JSON supported)
        '429':
          description: Too many requests; includes Retry-After header
          headers:
            Retry-After:
              description: Seconds until the next request is allowed
              schema:
                type: integer
                example: 60

  /api/embed/flag:
    post:
      summary: Flag statement from embed
      description: Report a problematic statement from an embedded discussion.
      operationId: flagStatementFromEmbed
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - statement_id
                - flag_reason
              properties:
                statement_id:
                  type: integer
                flag_reason:
                  type: string
                  enum: [spam, harassment, misinformation, off_topic]
                ref:
                  type: string
                  description: Partner reference for tracking
      responses:
        '201':
          description: Flag recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '400':
          description: Invalid request
        '404':
          description: Statement not found
        '409':
          description: Already flagged from this session

  /api/partner/discussions:
    post:
      summary: Create discussion (authenticated)
      description: Create a discussion for an article not ingested via RSS. Requires X-API-Key header.
      operationId: createDiscussion
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - article_url
                - title
              properties:
                article_url:
                  type: string
                  format: uri
                title:
                  type: string
                  maxLength: 200
                excerpt:
                  type: string
                source_name:
                  type: string
                seed_statements:
                  type: array
                  items:
                    type: object
                    required: [content]
                    properties:
                      content:
                        type: string
                      position:
                        type: string
                        enum: [pro, con, neutral]
      responses:
        '201':
          description: Discussion created
          content:
            application/json:
              schema:
                type: object
                properties:
                  discussion_id:
                    type: integer
                  slug:
                    type: string
                  title:
                    type: string
                  embed_url:
                    type: string
                  consensus_url:
                    type: string
                  snapshot_url:
                    type: string
                  source:
                    type: string
                    example: partner
                  env:
                    type: string
                    enum: [test, live]
                  statement_count:
                    type: integer
        '400':
          description: Invalid request or missing excerpt/seed_statements
        '401':
          description: Missing or invalid API key
        '402':
          description: Live API requires active subscription
        '403':
          description: Partner inactive or browser request not allowed (use server-to-server)
        '409':
          description: Discussion already exists for this URL
        '429':
          description: Rate limit or tier limit exceeded; includes Retry-After header
          headers:
            Retry-After:
              description: Seconds until the next request is allowed (60 for rate limit, 3600 for tier limit)
              schema:
                type: integer
                example: 60

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: Partner API key (required for Create Discussion)
