{% extends "layout.html" %}
{% from "components/audio_player.html" import audio_player %}
{% from "components/voice_selector.html" import voice_selector %}
{% from "components/dive_deeper_links.html" import dive_deeper_links %}
{% from "components/email_capture.html" import email_capture_inline, email_capture_compact, paid_brief_crosssell %}
{% from "components/listen_with.html" import listen_with %}

{% block title %}{{ brief.title }} - Society Speaks{% endblock %}

{% block meta_description %}{{ (brief.intro_text or '')[:160] }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-slate-100 to-white">
    <header class="bg-blue-800 py-10 px-4 sm:px-6 lg:px-8">
        <div class="max-w-3xl mx-auto text-center">
            <p class="text-blue-300 text-xs font-semibold tracking-widest uppercase mb-3">Society Speaks</p>
            <h1 class="text-white text-3xl sm:text-4xl font-bold mb-3" style="font-family: Georgia, 'Times New Roman', Times, serif;">
                {% if brief.brief_type == 'weekly' %}The Weekly Brief{% else %}The Daily Brief{% endif %}
            </h1>
            <p class="text-blue-200 text-sm">
                {% if brief.brief_type == 'weekly' and brief.week_start_date and brief.week_end_date %}
                Week of {{ brief.week_start_date.strftime('%d %B') }} ‚Äì {{ brief.week_end_date.strftime('%d %B %Y') }}
                {% else %}
                {{ brief.date.strftime('%A, %d %B %Y') }} Edition
                {% endif %}
                {% if brief.reading_time %}<span class="mx-1">&middot;</span> ~{{ brief.reading_time }} min read{% endif %}
            </p>
            {% if brief.brief_type != 'weekly' %}
            <p class="text-blue-100 text-xs mt-2">Updated daily at 6pm UTC ‚Äî today's edition publishes this evening</p>
            {% endif %}
        </div>
    </header>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 -mt-6">
        {% if latest_weekly is defined and latest_weekly and brief.brief_type != 'weekly' %}
        <a href="{{ url_for('brief.weekly_latest') }}" class="block mb-6 rounded-xl border border-indigo-200 bg-white overflow-hidden shadow-sm hover:shadow-md transition-shadow group">
            <div class="bg-indigo-600 px-4 py-2">
                <p class="text-white font-semibold text-sm tracking-wide">üìã Weekly Brief Available</p>
            </div>
            <div class="px-4 py-3 flex items-center justify-between">
                <p class="text-slate-600 text-sm">
                    {% if latest_weekly.week_start_date and latest_weekly.week_end_date %}
                    Week of {{ latest_weekly.week_start_date.strftime('%d %b') }} ‚Äì {{ latest_weekly.week_end_date.strftime('%d %b %Y') }}
                    {% else %}
                    {{ latest_weekly.date.strftime('%d %B %Y') }}
                    {% endif %}
                    <span class="text-slate-400 mx-1">&middot;</span> ~{{ latest_weekly.reading_time or 6 }} min read
                </p>
                <span class="text-indigo-500 group-hover:text-indigo-700 transition-colors text-sm font-semibold whitespace-nowrap ml-4">Read &rarr;</span>
            </div>
        </a>
        {% endif %}

        {% if brief.brief_type == 'weekly' %}
        <a href="{{ url_for('brief.today') }}" class="block mb-6 rounded-xl border border-blue-200 bg-white overflow-hidden shadow-sm hover:shadow-md transition-shadow group">
            <div class="px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-lg">üì∞</span>
                    <p class="text-slate-600 text-sm font-medium">Back to today's Daily Brief</p>
                </div>
                <span class="text-blue-500 group-hover:text-blue-700 transition-colors text-sm font-semibold whitespace-nowrap ml-4">&larr; Daily Brief</span>
            </div>
        </a>
        {% endif %}

        <div class="bg-blue-50 rounded-xl border border-blue-200 p-5 sm:p-6 mb-8 shadow-sm">
            <p class="text-blue-800 text-base leading-relaxed">{{ brief.intro_text }}</p>
        </div>

        <!-- Listen With Dropdown -->
        <div class="mb-8 flex justify-center">
            {% set first_audio_item = items|selectattr('audio_url')|first %}
            {{ listen_with(
                has_audio=(first_audio_item is defined and first_audio_item.audio_url),
                audio_url=(first_audio_item.audio_url if first_audio_item is defined and first_audio_item.audio_url else none),
                reader_url=url_for('brief.reader_view', date_str=brief.date.strftime('%Y-%m-%d'), _external=True),
                brief_title=brief.title
            ) }}
        </div>

        {% if show_email_capture %}
        <div class="mb-8">
            {{ email_capture_compact() }}
        </div>
        {% endif %}

        <!-- Generate All Audio Section (Admin Only, when audio is enabled) -->
        {% if current_user.is_authenticated and current_user.is_admin and config.get('AUDIO_ENABLED', 'false').lower() == 'true' %}
        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl border border-purple-200 p-6 mb-8">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">Listen to the Brief</h3>
                    <p class="text-sm text-gray-600">Generate audio for all stories in this brief</p>
                </div>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full sm:w-auto">
                    {{ voice_selector('voice-select', 'text-sm border border-gray-300 rounded-lg px-3 py-2.5 sm:py-2 bg-white min-h-[44px] sm:min-h-0 flex-1 sm:flex-none') }}
                    <button data-brief-id="{{ brief.id }}"
                            id="generate-all-audio-btn"
                            class="inline-flex items-center justify-center gap-2 px-6 py-3 sm:py-2 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors min-h-[44px] sm:min-h-0 w-full sm:w-auto"
                            aria-label="Generate audio for all items in this brief">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                        <span>Generate All Audio</span>
                    </button>
                </div>
            </div>
            <div id="audio-generation-status" class="hidden mt-4">
                <div class="bg-white rounded-lg p-4 sm:p-5 border border-gray-200">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="flex-1 bg-gray-200 rounded-full h-2.5 sm:h-2">
                            <div id="audio-progress-bar" class="bg-purple-600 h-2.5 sm:h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <span id="audio-progress-text" class="text-sm font-medium text-gray-700 min-w-[3rem] text-right">0%</span>
                    </div>
                    <p id="audio-status-message" class="text-sm text-gray-600">Preparing...</p>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="space-y-8">
            {# ============================================================ #}
            {# SECTIONED LAYOUT (new briefs with section assignments)       #}
            {# ============================================================ #}
            {% if brief.is_sectioned %}
            {% set sections_data = brief.items_by_section %}

            {% for section_key, section_items in sections_data.items() %}

            {# Quick-hit items (global roundup) ‚Äî compact layout with header inside #}
            {% if section_key == 'global_roundup' %}
            <div class="rounded-2xl border border-gray-200 bg-white shadow-sm overflow-hidden">
                {% set sec = SECTIONS.get(section_key, {}) %}
                <div class="px-6 pt-5 pb-3 border-b border-gray-100">
                    <h2 class="text-sm font-bold tracking-widest uppercase {{ sec.get('web_color_class', 'text-slate-500') }}">
                        üåç {{ sec.get('display_name', 'Around the World') }}
                    </h2>
                    {% if sec.get('description') %}
                    <p class="text-xs text-gray-500 mt-1">{{ sec.description }}</p>
                    {% endif %}
                </div>
                <div class="divide-y divide-gray-100">
                    {% for item in section_items %}
                    <div id="item-{{ item.id }}" class="px-6 py-4">
                        <div class="flex items-start gap-3">
                            {% if item.trending_topic and item.trending_topic.geographic_countries %}
                            <span class="flex-shrink-0 text-xs font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded mt-0.5">
                                {{ item.trending_topic.geographic_countries.split(',')[0]|trim }}
                            </span>
                            {% endif %}
                            <div class="flex-1">
                                <h3 class="font-serif text-lg font-bold text-gray-900 leading-snug">{{ item.headline }}</h3>
                                {% if item.quick_summary %}
                                <p class="text-gray-600 text-sm mt-1.5 leading-relaxed">{{ item.quick_summary }}</p>
                                {% endif %}
                                {% if item.source_count %}
                                <span class="text-xs text-gray-400 mt-1 inline-block">{{ item.source_count }} sources</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            {# Standard and full depth items ‚Äî rendered as article cards #}
            {% for item in section_items %}
            <article id="item-{{ item.id }}" class="rounded-2xl shadow-lg border overflow-hidden {% if item.is_underreported %}bg-amber-50 border-amber-300{% else %}bg-white border-gray-100{% endif %}">
                <div class="p-6 sm:p-8">
                    {# Section header inside the first card of each section #}
                    {% if loop.first and section_key != '_unsectioned' %}
                    {% set sec = SECTIONS.get(section_key, {}) %}
                    <div class="mb-4 pb-3 border-b border-gray-100">
                        <h2 class="text-xs font-bold tracking-widest uppercase {{ sec.get('web_color_class', 'text-slate-500') }}">
                            {% if section_key == 'underreported' %}üì≠ {% endif %}{{ sec.get('display_name', section_key|replace('_', ' ')|title) }}
                        </h2>
                        {% if sec.get('description') and section_key != 'lead' %}
                        <p class="text-xs text-gray-500 mt-1">{{ sec.description }}</p>
                        {% endif %}
                    </div>
                    {% endif %}

                    {# Include shared item content partial #}
                    {% include "brief/_item_content.html" %}
                </div>
            </article>
            {% endfor %}
            {% endif %}
            {% endfor %}{# end sections loop #}

            {% else %}
            {# ============================================================ #}
            {# LEGACY FLAT LAYOUT (backward compatible for old briefs)      #}
            {# ============================================================ #}
            {% for item in items %}
            <article id="item-{{ item.id }}" class="rounded-2xl shadow-lg border overflow-hidden {% if item.is_underreported %}bg-amber-50 border-amber-300{% else %}bg-white border-gray-100{% endif %}">
                <div class="p-6 sm:p-8">
                    <!-- Thematic Section Heading -->
                    {% if item.trending_topic and item.trending_topic.primary_topic %}
                    {% set topic_lower = item.trending_topic.primary_topic.lower() %}
                    <div class="mb-3">
                        <span class="text-xs font-bold tracking-widest uppercase
                            {% if topic_lower in ['economy', 'business', 'finance', 'capital'] %}text-emerald-600
                            {% elif topic_lower in ['technology', 'tech', 'digital', 'ai'] %}text-violet-600
                            {% elif topic_lower in ['health', 'healthcare', 'medicine'] %}text-red-600
                            {% elif topic_lower in ['environment', 'climate'] %}text-teal-600
                            {% elif topic_lower in ['culture', 'society', 'arts'] %}text-fuchsia-600
                            {% elif topic_lower in ['international', 'world', 'global', 'geopolitics'] %}text-blue-600
                            {% elif topic_lower in ['policy', 'politics', 'government'] %}text-orange-600
                            {% else %}text-slate-500{% endif %}">
                            {% if topic_lower in ['economy', 'business', 'finance'] %}CAPITAL
                            {% elif topic_lower in ['technology', 'tech', 'digital', 'ai'] %}TECHNOLOGY
                            {% elif topic_lower in ['health', 'healthcare', 'medicine'] %}100-YEAR LIFE
                            {% elif topic_lower in ['environment', 'climate'] %}OUR PLANET
                            {% elif topic_lower in ['culture', 'society', 'arts'] %}CULTURE
                            {% elif topic_lower in ['international', 'world', 'global', 'geopolitics'] %}WORLD
                            {% elif topic_lower in ['policy', 'politics', 'government'] %}POLICY
                            {% elif topic_lower in ['education'] %}LEARNING
                            {% elif topic_lower in ['science'] %}SCIENCE
                            {% else %}{{ item.trending_topic.primary_topic|upper }}{% endif %}
                        </span>
                    </div>
                    {% endif %}
                    
                    {% if item.is_underreported %}
                    <div class="mb-5">
                        <span class="inline-flex items-center px-3 py-1.5 rounded-md bg-amber-500 text-white text-xs font-bold uppercase tracking-wider">
                            üì≠ Under the Radar
                        </span>
                        <p class="text-amber-800 text-xs mt-2 font-medium">High civic importance, low media coverage</p>
                    </div>
                    {% endif %}

                    <div class="flex items-start gap-4 mb-5">
                        {% if not item.is_underreported %}
                        <div class="flex-shrink-0 w-9 h-9 rounded-full bg-blue-800 text-white flex items-center justify-center font-bold text-base">
                            {{ item.position }}
                        </div>
                        {% endif %}
                        <h2 class="font-serif text-xl sm:text-2xl font-bold text-gray-900 leading-snug flex-1">
                            {{ item.headline }}
                        </h2>
                    </div>

                    <div class="flex flex-wrap items-center gap-2 mb-5">
                        {% if item.source_count and item.source_count > 0 %}
                        <span class="inline-flex items-center px-3 py-1 rounded-md bg-blue-800 text-white text-xs font-semibold">
                            <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                            </svg>
                            {{ item.source_count }} sources
                        </span>
                        {% endif %}

                        {% if item.sensationalism_label %}
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-md text-xs font-semibold whitespace-nowrap
                            {% if item.sensationalism_label == 'low' %}bg-green-100 text-green-800
                            {% elif item.sensationalism_label == 'medium' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {% if item.sensationalism_label == 'low' %}
                            <svg class="w-3 h-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            {% endif %}
                            <span>{{ item.sensationalism_label|capitalize }} sensationalism</span>
                        </span>
                        {% endif %}

                        {% if item.coverage_distribution %}
                        {% set left_pct = (item.coverage_distribution.get('left', 0) * 100)|int %}
                        {% set center_pct = (item.coverage_distribution.get('center', 0) * 100)|int %}
                        {% set right_pct = (item.coverage_distribution.get('right', 0) * 100)|int %}
                        {% set has_coverage = (left_pct + center_pct + right_pct) > 0 %}
                        {% if has_coverage and left_pct < 15 and right_pct > 30 %}
                        <span class="inline-flex items-center px-3 py-1 rounded-md bg-red-50 border border-red-200 text-red-700 text-xs font-semibold">
                            <svg class="w-3.5 h-3.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            Blindspot: {{ left_pct }}% left coverage
                        </span>
                        {% elif has_coverage and right_pct < 15 and left_pct > 30 %}
                        <span class="inline-flex items-center px-3 py-1 rounded-md bg-blue-50 border border-blue-200 text-blue-700 text-xs font-semibold">
                            <svg class="w-3.5 h-3.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            Blindspot: {{ right_pct }}% right coverage
                        </span>
                        {% endif %}
                        {% endif %}
                    </div>

                    {% if item.summary_bullets %}
                    <ul class="space-y-3 mb-6">
                        {% for bullet in item.summary_bullets %}
                        <li class="flex items-start">
                            <span class="text-blue-600 mr-3 mt-1 text-lg leading-none">&bull;</span>
                            <span class="text-gray-700 leading-relaxed">{{ bullet }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    <!-- Audio Player Section -->
                    {{ audio_player(item) }}

                    <!-- Dive Deeper with AI Section -->
                    {{ dive_deeper_links(item) }}

                    <!-- Want more detail? Section -->
                    {% if item.deeper_context %}
                    <div class="mb-6">
                        <button data-item-id="{{ item.id }}"
                                class="toggle-deeper-context-btn inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-blue-700 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors"
                                aria-expanded="false"
                                aria-controls="deeper-context-{{ item.id }}">
                            <svg data-icon-id="{{ item.id }}" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                            <span>Want a bit more detail?</span>
                        </button>
                        <div id="deeper-context-{{ item.id }}" 
                             class="hidden mt-4 p-5 bg-slate-50 border-l-4 border-slate-400 rounded-r-lg">
                            <div class="prose prose-sm max-w-none text-gray-700 leading-relaxed whitespace-pre-line">
                                {{ item.deeper_context }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if item.personal_impact %}
                    <div class="bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-5 mb-6">
                        <p class="text-xs font-bold text-blue-700 uppercase tracking-wide mb-2">üí° Why This Matters To You</p>
                        <p class="text-blue-900 leading-relaxed font-medium">{{ item.personal_impact }}</p>
                    </div>
                    {% endif %}

                    {% if item.so_what %}
                    <div class="bg-amber-50 border-l-4 border-amber-400 rounded-r-lg p-5 mb-6">
                        <p class="text-xs font-bold text-amber-700 uppercase tracking-wide mb-2">Why It Matters</p>
                        <p class="text-amber-900 leading-relaxed">{{ item.so_what|strip_so_what }}</p>
                    </div>
                    {% endif %}

                    {% if item.perspectives and (item.perspectives.get('left') or item.perspectives.get('center') or item.perspectives.get('right')) %}
                    <div class="bg-slate-50 rounded-xl p-5 mb-6">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-4">How It's Being Framed</p>
                        <div class="space-y-3">
                            {% if item.perspectives.get('left') %}
                            <div class="flex items-start gap-3">
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 text-xs font-bold flex-shrink-0">L</span>
                                <p class="text-gray-700 text-sm leading-relaxed"><span class="font-semibold text-blue-600">Left:</span> {{ item.perspectives.get('left') }}</p>
                            </div>
                            {% endif %}
                            {% if item.perspectives.get('center') %}
                            <div class="flex items-start gap-3">
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-purple-100 text-purple-600 text-xs font-bold flex-shrink-0">C</span>
                                <p class="text-gray-700 text-sm leading-relaxed"><span class="font-semibold text-purple-600">Centre:</span> {{ item.perspectives.get('center') }}</p>
                            </div>
                            {% endif %}
                            {% if item.perspectives.get('right') %}
                            <div class="flex items-start gap-3">
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-red-100 text-red-600 text-xs font-bold flex-shrink-0">R</span>
                                <p class="text-gray-700 text-sm leading-relaxed"><span class="font-semibold text-red-600">Right:</span> {{ item.perspectives.get('right') }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Market Signal Card -->
                    {% if item.market_signal %}
                    <div class="mt-4 bg-slate-50 border-l-4 border-indigo-500 rounded-r-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xs font-semibold text-indigo-600 uppercase tracking-wide">
                                üìä Market Signal
                            </span>
                            {% if item.market_signal.quality_tier == 'high' %}
                            <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">
                                High Volume
                            </span>
                            {% endif %}
                        </div>

                        <p class="text-base font-medium text-slate-800 mb-3">
                            "{{ item.market_signal.question }}"
                        </p>

                        <!-- Probability Bar -->
                        <div class="mb-3">
                            <div class="h-7 bg-slate-200 rounded overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-indigo-500 to-indigo-400 flex items-center justify-end pr-2"
                                     style="width: {{ (item.market_signal.probability * 100)|round }}%; min-width: 50px;">
                                    <span class="text-white font-semibold text-sm">
                                        {{ (item.market_signal.probability * 100)|round }}%
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="flex items-center gap-3 text-sm text-slate-500 mb-3">
                            {% if item.market_signal.change_24h_formatted and item.market_signal.change_24h_formatted != '‚Äî' %}
                            <span class="{% if item.market_signal.change_24h > 0 %}text-green-600{% elif item.market_signal.change_24h < 0 %}text-red-600{% endif %}">
                                {{ item.market_signal.change_24h_formatted }} today
                            </span>
                            <span>¬∑</span>
                            {% endif %}
                            <span>${{ "{:,.0f}".format(item.market_signal.volume_24h or 0) }} volume</span>
                            <span>¬∑</span>
                            <a href="{{ item.market_signal.url }}" target="_blank" rel="noopener"
                               class="text-indigo-600 hover:text-indigo-700">
                                View market ‚Üí
                            </a>
                        </div>

                        <!-- Disclaimer -->
                        <p class="text-xs text-slate-400 italic border-t border-slate-200 pt-3">
                            Markets reflect collective expectations, not certainty.
                            Prices move on new information, rumours, and sentiment.
                        </p>
                    </div>
                    {% endif %}

                    {% if item.blindspot_explanation %}
                    <div class="bg-amber-50 border-l-4 border-amber-500 rounded-r-lg p-5 mb-6">
                        <p class="text-xs font-bold text-amber-700 uppercase tracking-wide mb-2">üîç Coverage Gap Analysis</p>
                        <p class="text-amber-900 leading-relaxed italic">{{ item.blindspot_explanation }}</p>
                    </div>
                    {% endif %}

                    {% if item.coverage_distribution %}
                    {% set cov_left_pct = (item.coverage_distribution.get('left', 0) * 100)|int %}
                    {% set cov_center_pct = (item.coverage_distribution.get('center', 0) * 100)|int %}
                    {% set cov_right_pct = (item.coverage_distribution.get('right', 0) * 100)|int %}
                    {% set cov_total = cov_left_pct + cov_center_pct + cov_right_pct %}

                    {# Check which perspectives have actual sources - defensive for None/invalid types #}
                    {% set sources_dict = item.sources_by_leaning if item.sources_by_leaning is mapping else {} %}
                    {% set left_sources = sources_dict.get('left', []) or [] %}
                    {% set center_sources = sources_dict.get('center', []) or [] %}
                    {% set right_sources = sources_dict.get('right', []) or [] %}
                    {% set has_any_sources = left_sources|length > 0 or center_sources|length > 0 or right_sources|length > 0 %}

                    {# Only show coverage bar if we have actual sources to back it up #}
                    {% if cov_total > 0 and has_any_sources %}
                    <div class="mb-6">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-3">Coverage Balance</p>

                        <!-- Coverage Bar with proper colors -->
                        <div class="w-full h-3 rounded-full overflow-hidden mb-3" style="display: flex; background-color: #e5e7eb;">
                            {% if cov_left_pct > 0 %}
                            <div style="width: {{ cov_left_pct }}%; background-color: #3b82f6; height: 100%;"></div>
                            {% endif %}
                            {% if cov_center_pct > 0 %}
                            <div style="width: {{ cov_center_pct }}%; background-color: #a855f7; height: 100%;"></div>
                            {% endif %}
                            {% if cov_right_pct > 0 %}
                            <div style="width: {{ cov_right_pct }}%; background-color: #ef4444; height: 100%;"></div>
                            {% endif %}
                        </div>

                        <div class="flex justify-between text-xs">
                            <span class="text-blue-600 font-medium">
                                {% if left_sources|length > 0 %}{{ cov_left_pct }}% Left ({{ left_sources|length }}){% else %}<span class="text-gray-400">No left coverage</span>{% endif %}
                            </span>
                            <span class="text-purple-600 font-medium">
                                {% if center_sources|length > 0 %}{{ cov_center_pct }}% Centre ({{ center_sources|length }}){% else %}<span class="text-gray-400">No centre coverage</span>{% endif %}
                            </span>
                            <span class="text-red-600 font-medium">
                                {% if right_sources|length > 0 %}{{ cov_right_pct }}% Right ({{ right_sources|length }}){% else %}<span class="text-gray-400">No right coverage</span>{% endif %}
                            </span>
                        </div>

                        {# Show source names when available #}
                        {% if has_any_sources %}
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500">
                                {% if left_sources|length > 0 %}
                                <span><span class="text-blue-600 font-medium">Left:</span> {{ left_sources|join(', ') }}</span>
                                {% endif %}
                                {% if center_sources|length > 0 %}
                                <span><span class="text-purple-600 font-medium">Centre:</span> {{ center_sources|join(', ') }}</span>
                                {% endif %}
                                {% if right_sources|length > 0 %}
                                <span><span class="text-red-600 font-medium">Right:</span> {{ right_sources|join(', ') }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        {# Transparency note when perspectives are missing #}
                        {% if left_sources|length == 0 or right_sources|length == 0 %}
                        <p class="text-xs text-gray-400 mt-2 italic">
                            {% if left_sources|length == 0 and right_sources|length == 0 %}
                            Only centre sources covered this story.
                            {% elif left_sources|length == 0 %}
                            Left-leaning outlets did not cover this story in our source roster.
                            {% elif right_sources|length == 0 %}
                            Right-leaning outlets did not cover this story in our source roster.
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endif %}

                    <!-- Original News Sources ‚Äî deduplicated by URL -->
                    {% if item.trending_topic %}
                    {% set topic_articles = (topic_articles_by_topic_id.get(item.trending_topic.id, [])[:5] if topic_articles_by_topic_id is defined else item.trending_topic.articles.all()[:5]) %}
                    {% set verify_urls = item.verification_links | map(attribute='url') | list if item.verification_links else [] %}
                    {% set ns = namespace(seen_urls=[]) %}
                    {% set unique_sources = [] %}
                    {% for topic_article in topic_articles %}
                    {% if topic_article.article and topic_article.article.url %}
                    {% set art_url = topic_article.article.url %}
                    {% if art_url not in ns.seen_urls and art_url not in verify_urls %}
                    {% set ns.seen_urls = ns.seen_urls + [art_url] %}
                    {% set _ = unique_sources.append(topic_article) %}
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                    {% if unique_sources %}
                    <div class="mb-6">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-3">üì∞ Read the Original Sources</p>
                        <div class="space-y-2">
                            {% for topic_article in unique_sources %}
                            <a href="{{ topic_article.article.url }}" target="_blank" rel="noopener" 
                               class="block p-3 rounded-lg border-l-3 border-l-blue-500 bg-slate-50 hover:bg-blue-50 transition-colors group">
                                <p class="text-sm font-medium text-gray-800 group-hover:text-blue-700 leading-snug">
                                    {{ topic_article.article.title[:90] }}{% if topic_article.article.title|length > 90 %}...{% endif %}
                                </p>
                                <p class="text-xs text-gray-500 mt-1">
                                    {{ topic_article.article.source_name }}{% if topic_article.article.published_at %} &bull; {{ topic_article.article.published_at.strftime('%d %b %Y') }}{% endif %}
                                </p>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}

                    {% if item.verification_links %}
                    <div class="mb-6">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-3">üîó Verify It Yourself</p>
                        <div class="space-y-2">
                            {% for link in item.verification_links %}
                            <a href="{{ link.url }}" target="_blank" rel="noopener" 
                               class="flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-colors group">
                                <div class="flex items-center gap-2">
                                    {% if link.tier == 'primary' %}
                                    <span class="inline-flex items-center justify-center w-5 h-5 rounded bg-green-100 text-green-600">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                        </svg>
                                    </span>
                                    {% else %}
                                    <span class="inline-flex items-center justify-center w-5 h-5 rounded bg-gray-100 text-gray-500">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                        </svg>
                                    </span>
                                    {% endif %}
                                    <span class="text-sm text-gray-700 group-hover:text-blue-700">{{ link.description }}</span>
                                    {% if link.is_paywalled %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-100 text-gray-500">
                                        <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                                        </svg>
                                        Paywall
                                    </span>
                                    {% endif %}
                                </div>
                                <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if item.discussion and item.discussion.slug %}
                    <div class="pt-4 border-t border-gray-100">
                        <a href="{{ url_for('discussions.view_discussion', discussion_id=item.discussion.id, slug=item.discussion.slug) }}" 
                           class="inline-flex items-center justify-center w-full sm:w-auto px-6 py-3 bg-blue-800 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
                            </svg>
                            {{ item.cta_text or 'Join the Discussion' }}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
            {% endif %}{# end is_sectioned check #}
        </div>

        <!-- Week Ahead Section -->
        {% if brief.week_ahead %}
        <div class="rounded-2xl shadow-lg border border-violet-200 overflow-hidden bg-gradient-to-br from-violet-50 to-indigo-50 mt-8">
            <div class="p-6 sm:p-8">
                <div class="flex items-center gap-3 mb-5">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-violet-600 text-white text-lg">üìÖ</span>
                    <div>
                        <h2 class="font-serif text-xl sm:text-2xl font-bold text-gray-900">The Week Ahead</h2>
                        <p class="text-sm text-violet-700">Key dates and events to watch</p>
                    </div>
                </div>
                <div class="space-y-3">
                    {% for event in brief.week_ahead %}
                    <div class="bg-white rounded-xl p-4 border border-violet-100 flex items-start gap-4">
                        <div class="flex-shrink-0 text-center min-w-[60px]">
                            <p class="text-xs font-bold text-violet-600 uppercase">{{ event.date.split(',')[0] if ',' in event.date else event.date }}</p>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-900 text-sm">{{ event.title }}</p>
                            {% if event.description %}
                            <p class="text-gray-600 text-xs mt-1">{{ event.description }}</p>
                            {% endif %}
                            {% if event.source_url %}
                            <a href="{{ event.source_url }}" target="_blank" rel="noopener" class="text-xs text-violet-600 hover:underline mt-1 inline-block">More info &rarr;</a>
                            {% endif %}
                        </div>
                        {% if event.category %}
                        <span class="flex-shrink-0 text-xs font-medium text-violet-600 bg-violet-100 px-2 py-0.5 rounded">{{ event.category|title }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- What the World is Watching Section -->
        {% if brief.world_events %}
        <div class="rounded-2xl shadow-lg border border-sky-200 overflow-hidden bg-gradient-to-br from-slate-50 to-sky-50 mt-8">
            <div class="p-6 sm:p-8">
                <div class="flex items-center gap-3 mb-5">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-sky-500 text-white text-lg">üåç</span>
                    <div>
                        <h2 class="font-serif text-xl sm:text-2xl font-bold text-gray-900">What the World is Watching</h2>
                        <p class="text-sm text-sky-700">Where prediction markets see the biggest stakes</p>
                    </div>
                </div>
                <div class="space-y-4">
                    {% for market in brief.world_events %}
                    <div class="bg-white rounded-xl p-5 border border-sky-100">
                        <div class="flex items-start justify-between gap-3 mb-3">
                            <p class="text-base font-medium text-slate-800">"{{ market.question }}"</p>
                            {% if market.category %}
                            <span class="flex-shrink-0 text-xs font-medium text-sky-700 bg-sky-100 px-2 py-0.5 rounded whitespace-nowrap">{{ market.category|title }}</span>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <div class="relative h-7 bg-slate-200 rounded overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-sky-500 to-sky-400 rounded"
                                     style="width: {{ (market.probability * 100)|round }}%;"></div>
                                <span class="absolute inset-0 flex items-center px-3 text-sm font-semibold {% if (market.probability * 100)|round > 40 %}text-white{% else %}text-slate-700{% endif %}">
                                    {{ (market.probability * 100)|round }}%
                                </span>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-3 text-sm text-slate-500">
                            {% if market.change_24h_formatted and market.change_24h_formatted != '‚Äî' %}
                            <span class="font-semibold {% if market.change_24h > 0 %}text-green-600{% elif market.change_24h < 0 %}text-red-600{% endif %}">
                                {{ market.change_24h_formatted }} today
                            </span>
                            <span>&middot;</span>
                            {% endif %}
                            <span>${{ "{:,.0f}".format(market.volume_24h or 0) }} volume</span>
                            {% if market.trader_count %}
                            <span>&middot;</span>
                            <span>{{ "{:,.0f}".format(market.trader_count) }} traders</span>
                            {% endif %}
                            <span>&middot;</span>
                            <a href="{{ market.url }}" target="_blank" rel="noopener" class="text-sky-600 hover:text-sky-700 font-medium">View market &rarr;</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <p class="text-xs text-gray-400 italic mt-4 text-center">
                    Prediction market probabilities reflect collective expectations. Prices move on news, rumours, and sentiment ‚Äî they are not forecasts.
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Market Pulse Section -->
        {% if brief.market_pulse %}
        <div class="rounded-2xl shadow-lg border border-indigo-200 overflow-hidden bg-gradient-to-br from-slate-50 to-indigo-50 mt-8">
            <div class="p-6 sm:p-8">
                <div class="flex items-center gap-3 mb-5">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-600 text-white text-lg">üìä</span>
                    <div>
                        <h2 class="font-serif text-xl sm:text-2xl font-bold text-gray-900">Market Pulse</h2>
                        <p class="text-sm text-indigo-700">What prediction markets are pricing in</p>
                    </div>
                </div>
                <div class="space-y-4">
                    {% for market in brief.market_pulse %}
                    <div class="bg-white rounded-xl p-5 border border-indigo-100">
                        <p class="text-base font-medium text-slate-800 mb-3">"{{ market.question }}"</p>
                        <div class="mb-3">
                            <div class="relative h-7 bg-slate-200 rounded overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-indigo-500 to-indigo-400 rounded"
                                     style="width: {{ (market.probability * 100)|round }}%;"></div>
                                <span class="absolute inset-0 flex items-center px-3 text-sm font-semibold {% if (market.probability * 100)|round > 40 %}text-white{% else %}text-slate-700{% endif %}">
                                    {{ (market.probability * 100)|round }}%
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 text-sm text-slate-500">
                            {% if market.change_24h_formatted and market.change_24h_formatted != '‚Äî' %}
                            <span class="{% if market.change_24h > 0 %}text-green-600{% elif market.change_24h < 0 %}text-red-600{% endif %}">
                                {{ market.change_24h_formatted }} today
                            </span>
                            <span>&middot;</span>
                            {% endif %}
                            <span>${{ "{:,.0f}".format(market.volume_24h or 0) }} volume</span>
                            <span>&middot;</span>
                            <a href="{{ market.url }}" target="_blank" rel="noopener" class="text-indigo-600 hover:text-indigo-700">View market &rarr;</a>
                        </div>
                        {% if market.matched_topic %}
                        <p class="text-xs text-gray-400 mt-2">Related to: {{ market.matched_topic }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                <p class="text-xs text-gray-400 italic mt-4 text-center">
                    Markets reflect collective expectations, not certainty. Prices move on new information, rumours, and sentiment.
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Same Story, Different Lens Section -->
        {% if brief.lens_check %}
        <article class="rounded-2xl shadow-lg border border-purple-200 overflow-hidden bg-gradient-to-br from-purple-50 to-indigo-50 mt-8">
            <div class="p-6 sm:p-8">
                <!-- Header -->
                <div class="flex items-center gap-3 mb-4">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-purple-600 text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </span>
                    <div>
                        <h2 class="font-serif text-xl sm:text-2xl font-bold text-gray-900">Same Story, Different Lens</h2>
                        <p class="text-sm text-purple-700">How outlets across the spectrum frame the same news</p>
                    </div>
                </div>

                <!-- Story Summary -->
                <div class="bg-white rounded-xl p-5 mb-6 border border-purple-100">
                    <p class="text-xs font-bold text-purple-600 uppercase tracking-wide mb-2">The Story</p>
                    <p class="text-gray-800 font-medium leading-relaxed">{{ brief.lens_check.story_summary }}</p>
                    {% if brief.lens_check.selection_criteria %}
                    <p class="text-xs text-gray-500 mt-3">
                        Based on {{ brief.lens_check.selection_criteria.total_sources }} sources 
                        ({{ brief.lens_check.selection_criteria.left_sources }}L / {{ brief.lens_check.selection_criteria.centre_sources }}C / {{ brief.lens_check.selection_criteria.right_sources }}R)
                    </p>
                    {% endif %}
                </div>

                <!-- Three Perspectives Grid -->
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <!-- Left Perspective -->
                    {% if brief.lens_check.perspectives.left %}
                    <div class="bg-white rounded-xl p-5 border-t-4 border-blue-500">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-blue-100 text-blue-700 text-sm font-bold flex-shrink-0">L</span>
                            <span class="text-sm font-bold text-blue-700 uppercase tracking-wide">Left</span>
                            <span class="text-xs text-gray-500">({{ brief.lens_check.perspectives.left.source_count }} sources)</span>
                        </div>
                        {% if brief.lens_check.perspectives.left.emphasis %}
                        <p class="text-xs text-gray-600 mb-3">
                            <span class="font-semibold">Emphasis:</span> {{ brief.lens_check.perspectives.left.emphasis }}
                        </p>
                        {% endif %}
                        <div class="space-y-3">
                            {% for headline in brief.lens_check.perspectives.left.headlines %}
                            <a href="{{ headline.url }}" target="_blank" rel="noopener" class="block group">
                                <p class="text-sm text-gray-800 group-hover:text-blue-700 font-medium leading-snug break-words">"{{ headline.title }}"</p>
                                <p class="text-xs text-gray-500 mt-1">‚Äî {{ headline.source }}</p>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Centre Perspective -->
                    {% if brief.lens_check.perspectives.centre %}
                    <div class="bg-white rounded-xl p-5 border-t-4 border-purple-500">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-purple-100 text-purple-700 text-sm font-bold flex-shrink-0">C</span>
                            <span class="text-sm font-bold text-purple-700 uppercase tracking-wide">Centre</span>
                            <span class="text-xs text-gray-500">({{ brief.lens_check.perspectives.centre.source_count }} sources)</span>
                        </div>
                        {% if brief.lens_check.perspectives.centre.emphasis %}
                        <p class="text-xs text-gray-600 mb-3">
                            <span class="font-semibold">Emphasis:</span> {{ brief.lens_check.perspectives.centre.emphasis }}
                        </p>
                        {% endif %}
                        <div class="space-y-3">
                            {% for headline in brief.lens_check.perspectives.centre.headlines %}
                            <a href="{{ headline.url }}" target="_blank" rel="noopener" class="block group">
                                <p class="text-sm text-gray-800 group-hover:text-purple-700 font-medium leading-snug break-words">"{{ headline.title }}"</p>
                                <p class="text-xs text-gray-500 mt-1">‚Äî {{ headline.source }}</p>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Right Perspective -->
                    {% if brief.lens_check.perspectives.right %}
                    <div class="bg-white rounded-xl p-5 border-t-4 border-red-500">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-red-100 text-red-700 text-sm font-bold flex-shrink-0">R</span>
                            <span class="text-sm font-bold text-red-700 uppercase tracking-wide">Right</span>
                            <span class="text-xs text-gray-500">({{ brief.lens_check.perspectives.right.source_count }} sources)</span>
                        </div>
                        {% if brief.lens_check.perspectives.right.emphasis %}
                        <p class="text-xs text-gray-600 mb-3">
                            <span class="font-semibold">Emphasis:</span> {{ brief.lens_check.perspectives.right.emphasis }}
                        </p>
                        {% endif %}
                        <div class="space-y-3">
                            {% for headline in brief.lens_check.perspectives.right.headlines %}
                            <a href="{{ headline.url }}" target="_blank" rel="noopener" class="block group">
                                <p class="text-sm text-gray-800 group-hover:text-red-700 font-medium leading-snug break-words">"{{ headline.title }}"</p>
                                <p class="text-xs text-gray-500 mt-1">‚Äî {{ headline.source }}</p>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Contrast Analysis -->
                {% if brief.lens_check.contrast_analysis %}
                <div class="bg-amber-50 border-l-4 border-amber-400 rounded-r-lg p-5 mb-4">
                    <p class="text-xs font-bold text-amber-700 uppercase tracking-wide mb-2">üí° The Contrast</p>
                    <p class="text-amber-900 leading-relaxed">{{ brief.lens_check.contrast_analysis }}</p>
                </div>
                {% endif %}

                <!-- Omissions -->
                {% if brief.lens_check.omissions %}
                <div class="bg-slate-50 border-l-4 border-slate-400 rounded-r-lg p-5 mb-4">
                    <p class="text-xs font-bold text-slate-600 uppercase tracking-wide mb-2">üîç What's Missing</p>
                    <p class="text-slate-700 leading-relaxed">{{ brief.lens_check.omissions }}</p>
                </div>
                {% endif %}

                <!-- Methodology Note -->
                <div class="text-center pt-4 border-t border-purple-100">
                    <p class="text-xs text-gray-500">
                        Source classifications based on <a href="https://allsides.com/media-bias" target="_blank" rel="noopener" class="text-purple-600 hover:underline">AllSides media bias ratings</a>.
                        <a href="{{ url_for('brief.methodology') }}" class="text-purple-600 hover:underline ml-1">Learn more about our methodology</a>.
                    </p>
                </div>
            </div>
        </article>
        {% endif %}

        {% if show_email_capture %}
        <div class="mt-8">
            {{ email_capture_inline(context='brief') }}
        </div>
        
        <div class="mt-8">
            {{ paid_brief_crosssell() }}
        </div>
        {% else %}
        <!-- Conversion CTA for free daily brief subscribers -->
        <div class="bg-gradient-to-br from-blue-800 to-indigo-900 rounded-2xl shadow-xl p-8 mt-8 text-center">
            <div class="max-w-xl mx-auto">
                <h3 class="text-xl font-bold text-white mb-3">Like this brief? Get one tailored to you.</h3>
                <p class="text-blue-200 mb-6 leading-relaxed">
                    Create a brief like this one, with your own sources, topics, and schedule. Paid briefs fund the open source technology that keeps Society Speaks free for everyone.
                </p>
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <a href="{{ url_for('briefing.landing') }}" class="inline-flex items-center justify-center px-6 py-3 bg-white text-blue-800 font-semibold rounded-lg hover:bg-blue-50 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Get Your Own Brief
                    </a>
                    <button onclick="navigator.share ? navigator.share({title: '{{ brief.title }}', url: window.location.href}) : navigator.clipboard.writeText(window.location.href).then(() => alert('Link copied!'))" 
                            class="inline-flex items-center justify-center px-6 py-3 bg-blue-700 text-white font-medium rounded-lg hover:bg-blue-600 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                        </svg>
                        Share This Brief
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="text-center text-sm text-gray-500 pb-8">
            <a href="{{ url_for('brief.archive') }}" class="hover:text-gray-700">View Archive</a>
            <span class="mx-2">|</span>
            <a href="{{ url_for('brief.methodology') }}" class="hover:text-gray-700">How We Select Stories</a>
        </div>
    </div>
</div>

<style>
/* Template-specific mobile optimizations */
@media (max-width: 640px) {
    #toast-container {
        top: 1rem;
        right: 1rem;
        left: 1rem;
        max-width: none;
        width: auto;
    }
    
    .toast {
        min-width: auto;
        width: 100%;
    }
    
    /* Larger touch targets for mobile */
    .toast-close {
        min-width: 44px;
        min-height: 44px;
        padding: 8px;
    }
    
    /* Better mobile audio player */
    audio {
        width: 100%;
        height: 48px; /* Larger for mobile */
    }
    
    /* Mobile-friendly buttons */
    button, .inline-flex {
        min-height: 44px; /* iOS recommended touch target */
    }
    
    /* Better spacing on mobile */
    .space-y-8 > * + * {
        margin-top: 1.5rem;
    }
}
</style>

{# JavaScript is now in shared files: toast.js and brief-audio.js #}
{% endblock %}
