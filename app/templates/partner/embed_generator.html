{% extends "layout.html" %}

{% block title %}Embed Code Generator - Society Speaks{% endblock %}

{% block meta_description %}Generate embed code for Society Speaks. Publishers can add a clean voting widget to articles, with developer-friendly customization and clear audience insight for editors.{% endblock %}

{% block content %}
<div class="bg-gradient-to-b from-blue-50 to-white">
  <div class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8 lg:py-14">
    <header class="space-y-4">
      <nav class="text-sm text-gray-500">
        <a href="{{ url_for('partner.hub') }}" class="hover:text-blue-600">For Publishers</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">Embed Generator</span>
      </nav>
      <div class="grid gap-6 lg:grid-cols-12 lg:items-center">
        <div class="lg:col-span-7 space-y-4">
          <h1 class="text-3xl font-bold text-gray-900 sm:text-4xl">Embed Code Generator</h1>
          <p class="text-lg text-gray-600">
            Add a Society Speaks voting widget to your article in minutes. Developers get a clean iframe
            and customization controls. Editors get structured insight, not comment noise.
          </p>
          <div class="flex flex-wrap gap-3">
            <a href="{{ url_for('partner.api_docs') }}" class="inline-flex items-center rounded-md bg-white px-4 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
              API Reference
            </a>
            <a href="mailto:info@societyspeaks.io" class="inline-flex items-center rounded-md bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
              Contact
            </a>
          </div>
          <p class="text-sm text-gray-500">Embeds are available for Society Speaks native discussions.</p>
        </div>
        <div class="lg:col-span-5">
          <div class="rounded-xl border border-blue-100 bg-white p-5 shadow-sm">
            <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">Implementation checklist</p>
            <ul class="mt-3 space-y-2 text-sm text-gray-700">
              <li class="flex items-start">
                <svg class="w-4 h-4 text-emerald-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Confirm your domain is allowlisted
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-emerald-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Generate the iframe below
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-emerald-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Add auto-resize for a seamless UX
              </li>
            </ul>
          </div>
        </div>
      </div>
    </header>
  </div>
</div>

<div class="mx-auto max-w-7xl px-4 pb-12 sm:px-6 lg:px-8">
  <div class="rounded-xl border border-blue-100 bg-blue-50 p-5 text-sm text-blue-900 mb-8">
    <p class="font-semibold mb-1">Use the Partner Portal for production onboarding</p>
    <p>
      Create your test keys, verify domains, and activate live keys from the
      <a href="{{ url_for('partner.portal_signup') }}" class="underline">Partner Portal</a>. For scale,
      use the API to create discussions and store the returned <strong>discussion ID</strong> in your CMS.
      See the <a href="{{ url_for('partner.api_docs') }}" class="underline">API Reference</a> for the
      programmatic workflow.
    </p>
  </div>
  <div class="grid gap-6 md:grid-cols-3">
    <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">For developers</h3>
      <p class="text-sm text-gray-600">A lightweight iframe, predictable params, and postMessage resize hooks.</p>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">For editors</h3>
      <p class="text-sm text-gray-600">Structured participation, clear consensus signals, and auditable methodology.</p>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">For audiences</h3>
      <p class="text-sm text-gray-600">Vote in seconds, see where the public aligns, and explore deeper analysis.</p>
    </div>
  </div>

  <div class="grid gap-6 md:grid-cols-3 mt-8">
    <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">At-scale flow</h3>
      <p class="text-sm text-gray-600">
        1) Lookup by article URL, 2) create if missing, 3) store discussion ID.
      </p>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">What is a discussion ID?</h3>
      <p class="text-sm text-gray-600">
        A unique identifier returned by the API when a discussion is created or found.
      </p>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">No discussion yet?</h3>
      <p class="text-sm text-gray-600">
        Call <code>POST /api/partner/discussions</code> to create one, then embed immediately.
      </p>
    </div>
  </div>

  <div class="grid lg:grid-cols-2 gap-8 mt-10">
    <!-- Input Form -->
    <div class="space-y-6">
      <!-- Article URL Lookup -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="font-semibold text-gray-900 mb-4">1. Find Your Discussion</h2>

        <div class="space-y-4">
          <div>
            <label for="articleUrl" class="block text-sm font-medium text-gray-700 mb-1">Article URL</label>
            <div class="flex flex-col sm:flex-row gap-2">
              <input
                type="url"
                id="articleUrl"
                placeholder="https://yoursite.com/article/..."
                class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
              <button
                type="button"
                onclick="lookupArticle()"
                id="lookupBtn"
                class="w-full sm:w-auto px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                Look Up
              </button>
            </div>
            <p id="lookupStatus" class="text-sm mt-2 hidden"></p>
          </div>

          <div class="text-center text-gray-400 text-sm">or</div>

          <div>
            <label for="discussionId" class="block text-sm font-medium text-gray-700 mb-1">Discussion ID</label>
            <input
              type="number"
              id="discussionId"
              placeholder="e.g., 123"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              onchange="updatePreview()"
            >
            <p class="text-xs text-gray-500 mt-1">Returned by the API when a discussion is created or found.</p>
          </div>
        </div>

        <!-- Discussion Preview -->
        <div id="discussionPreview" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
          <p class="text-sm text-gray-500 mb-1">Discussion found:</p>
          <p id="discussionTitle" class="font-semibold text-gray-900"></p>
        </div>
      </div>

      <!-- Theme Selection -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="font-semibold text-gray-900 mb-4">2. Choose a Theme</h2>

        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
          {% for theme in themes %}
          <label class="relative cursor-pointer">
            <input
              type="radio"
              name="theme"
              value="{{ theme.id }}"
              data-primary="{{ theme.primary }}"
              data-bg="{{ theme.bg }}"
              data-font="{{ theme.font }}"
              class="peer sr-only"
              {% if loop.first %}checked{% endif %}
              onchange="applyThemePreset(this); updatePreview()"
            >
            <div class="p-3 border-2 border-gray-200 rounded-lg peer-checked:border-blue-600 peer-checked:bg-blue-50 transition-colors">
              <div class="flex items-center gap-2 mb-1.5">
                <span class="w-5 h-5 rounded-full border border-gray-200 flex-shrink-0" style="background-color: #{{ theme.bg }};">
                  <span class="block w-2.5 h-2.5 rounded-full mx-auto mt-[5px]" style="background-color: #{{ theme.primary }};"></span>
                </span>
                <span class="font-medium text-gray-900 text-sm">{{ theme.name }}</span>
              </div>
              {% if theme.font %}
              <span class="text-[10px] text-gray-400">{{ theme.font }}</span>
              {% endif %}
            </div>
          </label>
          {% endfor %}
        </div>

        <!-- Custom Colors (shown when custom selected or always) -->
        <div id="customTheme" class="space-y-3 pt-4 border-t border-gray-200">
          <p class="text-sm text-gray-600">Or customize colors:</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label for="primaryColor" class="block text-xs font-medium text-gray-500 mb-1">Primary Color</label>
              <input
                type="color"
                id="primaryColor"
                value="#1e40af"
                class="w-full h-10 rounded border border-gray-200 cursor-pointer"
                onchange="selectCustomTheme()"
              >
            </div>
            <div>
              <label for="bgColor" class="block text-xs font-medium text-gray-500 mb-1">Background</label>
              <input
                type="color"
                id="bgColor"
                value="#ffffff"
                class="w-full h-10 rounded border border-gray-200 cursor-pointer"
                onchange="selectCustomTheme()"
              >
            </div>
          </div>
          <div>
            <label for="fontSelect" class="block text-xs font-medium text-gray-500 mb-1">Font</label>
            <select
              id="fontSelect"
              class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
              onchange="updatePreview()"
            >
              {% for font in fonts %}
              <option value="{{ font }}">{{ font }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- Partner Ref -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="font-semibold text-gray-900 mb-4">3. Add Your Reference (Optional)</h2>
        <div>
          <label for="partnerRef" class="block text-sm font-medium text-gray-700 mb-1">Partner Ref</label>
          <input
            type="text"
            id="partnerRef"
            placeholder="e.g., observer, time, mysite"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            onchange="updatePreview()"
          >
          <p class="text-xs text-gray-500 mt-1">Used for analytics. Lowercase, no spaces.</p>
        </div>
      </div>
    </div>

    <!-- Output -->
    <div class="space-y-6">
      <!-- Live Preview -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="font-semibold text-gray-900 mb-4">Preview</h2>
        <div id="previewContainer" class="bg-gray-100 rounded-lg p-4 min-h-[200px] flex items-center justify-center">
          <p class="text-gray-400 text-sm" id="previewPlaceholder">Enter a discussion ID or look up an article URL to see preview</p>
          <iframe
            id="previewFrame"
            class="w-full hidden"
            style="height: 400px; border: none; border-radius: 8px;"
            title="Embed preview"
          ></iframe>
        </div>
      </div>

      <!-- Generated Code -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold text-gray-900">Embed Code</h2>
          <button
            type="button"
            onclick="copyCodeFrom('embedCode', 'copyBtn')"
            id="copyBtn"
            class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            Copy
          </button>
        </div>
        <pre id="embedCode" class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto whitespace-pre-wrap"><code>&lt;!-- Enter a discussion ID to generate embed code --&gt;</code></pre>
      </div>

      <!-- Auto-resize Snippet -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold text-gray-900">Auto-resize Snippet</h2>
          <button
            type="button"
            onclick="copyCodeFrom('resizeSnippet', 'copyResizeBtn')"
            id="copyResizeBtn"
            class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            Copy
          </button>
        </div>
        <pre id="resizeSnippet" class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto whitespace-pre-wrap"><code>&lt;script&gt;
window.addEventListener('message', (event) =&gt; {
  if (event.data &amp;&amp; event.data.type === 'societyspeaks:embed:resize') {
    const iframe = document.getElementById('societyspeaks-embed');
    if (iframe) iframe.style.height = event.data.height + 'px';
  }
});
&lt;/script&gt;</code></pre>
      </div>

      <!-- Performance Hints -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold text-gray-900">Performance Hints</h2>
          <button
            type="button"
            onclick="copyCodeFrom('preconnectSnippet', 'copyPreconnectBtn')"
            id="copyPreconnectBtn"
            class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            Copy
          </button>
        </div>
        <pre id="preconnectSnippet" class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto whitespace-pre-wrap"><code>&lt;link rel="preconnect" href="{{ base_url }}"&gt;
&lt;link rel="dns-prefetch" href="{{ base_url }}"&gt;</code></pre>
      </div>

      <!-- Tips -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="font-semibold text-blue-900 mb-2">Tips</h3>
        <ul class="text-blue-800 text-sm space-y-1">
          <li>Set iframe width to 100% for responsive embeds</li>
          <li>Default height is 600px; adjust based on statement count</li>
          <li>Add <code class="bg-blue-100 px-1 rounded">ref</code> to track participation from your site</li>
          <li>The embed posts its height via postMessage for dynamic sizing</li>
          <li>Add the auto-resize snippet to avoid scrollbars</li>
          <li>Use preconnect hints to speed up first paint</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  const BASE_URL = '{{ base_url }}';

  // Look up article URL via API
  async function lookupArticle() {
    const url = document.getElementById('articleUrl').value.trim();
    const statusEl = document.getElementById('lookupStatus');
    const lookupBtn = document.getElementById('lookupBtn');

    if (!url) {
      showStatus('Please enter an article URL', 'error');
      return;
    }

    lookupBtn.disabled = true;
    lookupBtn.textContent = 'Looking up...';
    showStatus('Searching...', 'info');

    try {
      const response = await fetch(`/api/discussions/by-article-url?url=${encodeURIComponent(url)}`);
      const data = await response.json();

      if (response.ok) {
        document.getElementById('discussionId').value = data.discussion_id;
        document.getElementById('discussionTitle').textContent = data.title;
        document.getElementById('discussionPreview').classList.remove('hidden');
        showStatus('Discussion found!', 'success');
        updatePreview();
      } else {
        showStatus(data.message || 'No discussion found for this URL', 'error');
        document.getElementById('discussionPreview').classList.add('hidden');
      }
    } catch (error) {
      showStatus('Error looking up article. Please try again.', 'error');
    } finally {
      lookupBtn.disabled = false;
      lookupBtn.textContent = 'Look Up';
    }
  }

  function showStatus(message, type) {
    const statusEl = document.getElementById('lookupStatus');
    statusEl.textContent = message;
    statusEl.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-gray-600');
    statusEl.classList.add(
      type === 'success' ? 'text-green-600' :
      type === 'error' ? 'text-red-600' : 'text-gray-600'
    );
  }

  function applyThemePreset(radio) {
    // Sync custom colour pickers and font selector with the selected preset
    var primary = radio.dataset.primary || '1e40af';
    var bg = radio.dataset.bg || 'ffffff';
    var font = radio.dataset.font || '';
    document.getElementById('primaryColor').value = '#' + primary;
    document.getElementById('bgColor').value = '#' + bg;
    var fontSelect = document.getElementById('fontSelect');
    if (font) {
      fontSelect.value = font;
    } else {
      fontSelect.selectedIndex = 0; // system-ui
    }
  }

  function selectCustomTheme() {
    // Deselect preset themes when user edits custom colours
    document.querySelectorAll('input[name="theme"]').forEach(el => el.checked = false);
    updatePreview();
  }

  function getSelectedTheme() {
    const selected = document.querySelector('input[name="theme"]:checked');
    return selected ? selected.value : null;
  }

  function buildEmbedUrl() {
    const discussionId = document.getElementById('discussionId').value;
    if (!discussionId) return null;

    let url = `${BASE_URL}/discussions/${discussionId}/embed`;
    const params = new URLSearchParams();

    const theme = getSelectedTheme();
    if (theme && theme !== 'default') {
      params.set('theme', theme);
    } else {
      // Custom colors
      const primary = document.getElementById('primaryColor').value.replace('#', '');
      const bg = document.getElementById('bgColor').value.replace('#', '');
      if (primary !== '1e40af') params.set('primary', primary);
      if (bg !== 'ffffff') params.set('bg', bg);
    }

    const font = document.getElementById('fontSelect').value;
    if (font && font !== 'system-ui') {
      params.set('font', font);
    }

    const ref = document.getElementById('partnerRef').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
    if (ref) {
      params.set('ref', ref);
    }

    if (params.toString()) {
      url += '?' + params.toString();
    }

    return url;
  }

  function updatePreview() {
    const discussionId = document.getElementById('discussionId').value;
    const previewFrame = document.getElementById('previewFrame');
    const placeholder = document.getElementById('previewPlaceholder');
    const codeEl = document.getElementById('embedCode').querySelector('code');

    if (!discussionId) {
      previewFrame.classList.add('hidden');
      placeholder.classList.remove('hidden');
      codeEl.textContent = '<!-- Enter a discussion ID to generate embed code -->';
      return;
    }

    const embedUrl = buildEmbedUrl();

    // Update preview iframe
    previewFrame.src = embedUrl;
    previewFrame.classList.remove('hidden');
    placeholder.classList.add('hidden');

    // Update code snippet
    const iframeCode = `<iframe
  id="societyspeaks-embed"
  src="${embedUrl}"
  width="100%"
  height="600"
  frameborder="0"
  title="Society Speaks discussion"
  loading="lazy"
></iframe>`;

    codeEl.textContent = iframeCode;
  }

  function copyCodeFrom(containerId, buttonId) {
    const code = document.getElementById(containerId).querySelector('code').textContent;
    const copyBtn = document.getElementById(buttonId);

    navigator.clipboard.writeText(code).then(() => {
      const originalText = copyBtn.innerHTML;
      copyBtn.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Copied!
      `;
      copyBtn.classList.add('bg-green-100', 'text-green-700');
      copyBtn.classList.remove('bg-gray-100', 'text-gray-700');

      setTimeout(() => {
        copyBtn.innerHTML = originalText;
        copyBtn.classList.remove('bg-green-100', 'text-green-700');
        copyBtn.classList.add('bg-gray-100', 'text-gray-700');
      }, 2000);
    });
  }

  // Listen for height messages from embed
  window.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'societyspeaks:embed:resize') {
      const frame = document.getElementById('previewFrame');
      if (frame && event.data.height) {
        frame.style.height = Math.min(event.data.height + 20, 800) + 'px';
      }
    }
  });

  // Handle Enter key in article URL field
  document.getElementById('articleUrl').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      lookupArticle();
    }
  });
</script>
{% endblock %}
