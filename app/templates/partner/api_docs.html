{% extends "layout.html" %}

{% block title %}API Reference - Society Speaks{% endblock %}

{% block meta_description %}API documentation for Society Speaks partner integration. Lookup discussions by article URL, show participation snapshots, and embed voting widgets with developer-friendly endpoints and clear governance for publishers.{% endblock %}

{% block content %}
<div class="bg-gradient-to-b from-blue-50 to-white">
  <div class="mx-auto max-w-7xl px-4 py-10 sm:px-6 lg:px-8 lg:py-14">
    <header class="space-y-4">
      <nav class="text-sm text-gray-500">
        <a href="{{ url_for('partner.hub') }}" class="hover:text-blue-600">For Publishers</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">API Reference</span>
      </nav>
      <div class="grid gap-6 lg:grid-cols-12 lg:items-center">
        <div class="lg:col-span-8 space-y-4">
          <h1 class="text-3xl font-bold text-gray-900 sm:text-4xl">Partner API Reference</h1>
          <p class="text-lg text-gray-600">
            Integrate Society Speaks programmatically. Power your embeds, snapshots, and editorial insights
            with JSON APIs built for newsroom workflows and developer velocity.
          </p>
          <div class="flex flex-wrap gap-3">
            <a href="{{ url_for('partner.api_playground') }}" class="inline-flex items-center rounded-md bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
              Open API Playground
            </a>
            <a href="{{ url_for('partner.portal_signup') }}" class="inline-flex items-center rounded-md bg-white px-4 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
              Partner Portal
            </a>
            <a href="{{ url_for('partner.embed_generator') }}" class="inline-flex items-center rounded-md bg-white px-4 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
              Embed Generator
            </a>
            <a href="mailto:info@societyspeaks.io" class="inline-flex items-center rounded-md bg-white px-4 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
              Contact
            </a>
          </div>
        </div>
        <div class="lg:col-span-4">
          <div class="rounded-xl border border-blue-100 bg-white p-5 shadow-sm">
            <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">Quick start</p>
            <div class="code-block relative group mt-3">
              <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
              <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-xs whitespace-pre-wrap break-words">curl "{{ base_url }}/api/discussions/by-article-url?url=https://example.com/article"</pre>
            </div>
            <p class="text-xs text-gray-500 mt-2">Then embed with the returned <code>embed_url</code>.</p>
          </div>
        </div>
      </div>

      <div class="grid gap-6 lg:grid-cols-3 pt-4">
        <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">For developers</h3>
          <p class="text-sm text-gray-600">Predictable endpoints, clear error codes, and copy/paste examples.</p>
        </div>
        <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">For editorial leaders</h3>
          <p class="text-sm text-gray-600">Reliable participation signals and a transparent, auditable methodology.</p>
        </div>
        <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">For governance</h3>
          <p class="text-sm text-gray-600">Rate limits, attribution requirements, and a clear source of truth.</p>
        </div>
      </div>

      <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <h3 class="font-semibold text-blue-900 mb-2">Testing the API</h3>
        <ul class="text-blue-800 text-sm space-y-1">
          <li><strong>Partner Portal:</strong> <a href="{{ url_for('partner.portal_signup') }}" class="underline font-medium">Create a portal</a> to get your test API key and DNS verification token.</li>
          <li><strong>Interactive playground:</strong> <a href="{{ url_for('partner.api_playground') }}" class="underline font-medium">Open API Playground</a> to try lookup, snapshot, and oEmbed from your browser (Swagger UI). Requests run against this site.</li>
          <li><strong>Create Discussion</strong> requires an API key; add it in the playground using the Authorize button (X-API-Key).</li>
          <li><strong>From the command line:</strong> use the <code class="bg-blue-100 px-1 rounded">curl</code> examples in each section below, replacing the base URL and parameters as needed.</li>
        </ul>
      </div>
    </header>
  </div>
</div>

<div class="mx-auto max-w-7xl px-4 pb-12 sm:px-6 lg:px-8">
  <div class="lg:grid lg:grid-cols-12 lg:gap-10">
    <!-- Sidebar navigation (desktop: sticky, mobile: horizontal scroll) -->
    <nav id="docsSidebar" class="hidden lg:block lg:col-span-3">
      <div class="sticky top-6 space-y-1 text-sm">
        <p class="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-3">On this page</p>
        <a href="#auth" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">Authentication</a>
        <a href="#base-url" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">Base URL</a>
        <a href="#workflows" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">Common Workflows</a>
        <a href="#lookup" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">Lookup by Article URL</a>
        <a href="#snapshot" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">Discussion Snapshot</a>
        <a href="#embed-url-parameters" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">Embed URL Parameters</a>
        <a href="#embed-sessions" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">Session Tracking &amp; Privacy</a>
        <a href="#postmessage" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">PostMessage Events</a>
        <a href="#oembed" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">oEmbed Provider</a>
        <a href="#create-discussion" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">Create Discussion</a>
        <a href="#cost-protection" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">Cost &amp; Abuse Protection</a>
        <a href="#rate-limits" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">Rate Limits</a>
        <a href="#error-format" class="docs-nav-link block rounded-md px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors">Error Format</a>
      </div>
    </nav>
    <!-- Mobile jump-to nav -->
    <div class="lg:hidden mb-6 -mx-4 px-4 overflow-x-auto" style="-ms-overflow-style:none;scrollbar-width:none">
      <div class="flex gap-2 text-xs whitespace-nowrap pb-2">
        <a href="#auth" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">Auth</a>
        <a href="#base-url" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">Base URL</a>
        <a href="#workflows" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">Workflows</a>
        <a href="#lookup" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">Lookup</a>
        <a href="#snapshot" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">Snapshot</a>
        <a href="#embed-url-parameters" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">Embed Params</a>
        <a href="#embed-sessions" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">Sessions</a>
        <a href="#postmessage" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">PostMessage</a>
        <a href="#oembed" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">oEmbed</a>
        <a href="#create-discussion" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">Create</a>
        <a href="#cost-protection" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">Cost Protection</a>
        <a href="#rate-limits" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">Rate Limits</a>
        <a href="#error-format" class="rounded-full bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200 active:bg-gray-300 transition-colors">Errors</a>
      </div>
    </div>
    <div class="lg:col-span-9 space-y-12">
    <section id="auth">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Authentication & Environments</h2>
      <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm">
        <p class="text-sm text-gray-700 mb-3">
          Use test keys for staging and live keys for production. Both run on the same base URL and are
          isolated by key type. Keys are issued in the Partner Portal.
        </p>
        <div class="grid gap-3 md:grid-cols-2 text-sm text-gray-700">
          <div class="bg-gray-50 rounded-lg p-3">
            <strong>Test key:</strong> <code>sspk_test_...</code>
          </div>
          <div class="bg-gray-50 rounded-lg p-3">
            <strong>Live key:</strong> <code>sspk_live_...</code> (activated after billing)
          </div>
        </div>
        <p class="text-sm text-gray-600 mt-3">
          Domains must be verified via DNS TXT to allow embeds.
        </p>
        <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
          <p class="text-sm font-semibold text-amber-900 mb-1">Server-to-server only for write operations</p>
          <p class="text-sm text-amber-800">
            The <code>X-API-Key</code> header is intentionally excluded from browser CORS preflight.
            <strong>Create Discussion</strong> must be called from your server, not from client-side JavaScript
            (requests with an <code>Origin</code> header are rejected with <code>403</code>).
            Read-only endpoints (Lookup, Snapshot, oEmbed) work from browsers without an API key.
            If you need authenticated lookups from the browser, proxy through your own backend.
          </p>
        </div>
      </div>
    </section>
    <!-- Base URL -->
    <section id="base-url">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Base URL</h2>
      <div class="code-block relative group">
        <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
        <code class="block bg-gray-900 text-green-400 px-4 py-3 rounded-lg">{{ base_url }}/api</code>
      </div>
    </section>

    <!-- Common Workflows -->
    <section id="workflows">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Common Workflows</h2>
      <div class="grid gap-6 lg:grid-cols-2">
        <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm">
          <h3 class="font-semibold text-gray-900 mb-2">Programmatic embed (recommended)</h3>
          <ol class="text-sm text-gray-700 space-y-2">
            <li>1) Lookup discussion by article URL</li>
            <li>2) If none exists, create discussion</li>
            <li>3) Store <code>discussion_id</code> and use <code>embed_url</code></li>
          </ol>
          <div class="code-block relative group mt-4">
            <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
            <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-xs whitespace-pre-wrap break-words"># 1) Lookup
curl "{{ base_url }}/api/discussions/by-article-url?url=https://example.com/article" \
  -H "X-API-Key: sspk_test_..."

# 2) If 404, create
curl -X POST "{{ base_url }}/api/partner/discussions" \
  -H "X-API-Key: sspk_test_..." \
  -H "Content-Type: application/json" \
  -d '{"article_url":"https://example.com/article","title":"Example title","excerpt":"..."}'</pre>
          </div>
        </div>
        <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm">
          <h3 class="font-semibold text-gray-900 mb-2">Manual embed (quick start)</h3>
          <p class="text-sm text-gray-700">
            Use the Embed Generator to create one-off iframes. It relies on the same
            APIs and returns the same <code>discussion_id</code> and <code>embed_url</code>.
          </p>
          <div class="mt-4">
            <a href="{{ url_for('partner.embed_generator') }}" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
              Open embed generator
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Lookup API -->
    <section id="lookup">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Lookup by Article URL</h2>
      <p class="text-gray-600 mb-4">Find a discussion by the URL of your article.</p>

      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
          <code class="text-sm">
            <span class="text-blue-600 font-bold">GET</span>
            <span class="text-gray-900">/api/discussions/by-article-url</span>
          </code>
        </div>
        <div class="p-4 space-y-4">
          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Query Parameters</h4>
            <div class="overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0">
            <table class="w-full text-sm min-w-[400px]">
              <tr class="border-b">
                <td class="py-2 font-mono text-purple-600">url</td>
                <td class="py-2 text-gray-500">required</td>
                <td class="py-2 text-gray-600">The article URL (URL-encoded)</td>
              </tr>
              <tr>
                <td class="py-2 font-mono text-purple-600">ref</td>
                <td class="py-2 text-gray-500">optional</td>
                <td class="py-2 text-gray-600">Partner reference for analytics</td>
              </tr>
            </table>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Example Request</h4>
            <div class="code-block relative group">
              <button class="copy-btn absolute top-10 right-2 z-10 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
              <div class="rounded-lg border border-gray-700 overflow-hidden ss-code-tabs">
                <div class="flex bg-gray-800 border-b border-gray-700 text-xs" role="tablist">
                  <button role="tab" aria-selected="true" data-lang="curl" class="ss-tab px-3 py-2 font-medium transition-colors text-white bg-gray-900">curl</button>
                  <button role="tab" aria-selected="false" data-lang="python" class="ss-tab px-3 py-2 font-medium transition-colors text-gray-400 hover:text-gray-200">Python</button>
                  <button role="tab" aria-selected="false" data-lang="node" class="ss-tab px-3 py-2 font-medium transition-colors text-gray-400 hover:text-gray-200">Node.js</button>
                </div>
                <pre class="bg-gray-900 text-green-400 p-3 text-sm whitespace-pre-wrap break-words ss-panel" data-lang="curl">curl "{{ base_url }}/api/discussions/by-article-url?url=https://example.com/article"</pre>
                <pre class="bg-gray-900 text-green-400 p-3 text-sm whitespace-pre-wrap break-words ss-panel" data-lang="python" hidden>import requests

resp = requests.get(
    "{{ base_url }}/api/discussions/by-article-url",
    params={"url": "https://example.com/article"}
)
data = resp.json()
embed_url = data["embed_url"]</pre>
                <pre class="bg-gray-900 text-green-400 p-3 text-sm whitespace-pre-wrap break-words ss-panel" data-lang="node" hidden>const resp = await fetch(
  `{{ base_url }}/api/discussions/by-article-url?` +
  new URLSearchParams({ url: "https://example.com/article" })
);
const data = await resp.json();
const embedUrl = data.embed_url;</pre>
              </div>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Success Response (200)</h4>
            <div class="code-block relative group">
              <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
              <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm whitespace-pre-wrap break-words">{
  "discussion_id": 123,
  "slug": "should-we-reform-housing-policy",
  "title": "Should we reform housing policy?",
  "embed_url": "{{ base_url }}/discussions/123/embed",
  "consensus_url": "{{ base_url }}/discussions/123/should-we.../consensus",
  "snapshot_url": "{{ base_url }}/api/discussions/123/snapshot",
  "source": "rss",
  "env": "live"
}</pre>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Error Responses</h4>
            <div class="space-y-2 text-sm">
              <div class="flex gap-4">
                <code class="text-red-600">400</code>
                <span class="text-gray-600"><code>missing_url</code> - URL parameter required</span>
              </div>
              <div class="flex gap-4">
                <code class="text-red-600">400</code>
                <span class="text-gray-600"><code>invalid_url</code> - URL could not be parsed</span>
              </div>
              <div class="flex gap-4">
                <code class="text-red-600">403</code>
                <span class="text-gray-600"><code>partner_disabled</code> - Embed and API access revoked for this partner ref</span>
              </div>
              <div class="flex gap-4">
                <code class="text-red-600">404</code>
                <span class="text-gray-600"><code>no_discussion</code> - No discussion for this URL</span>
              </div>
              <div class="flex gap-4">
                <code class="text-red-600">429</code>
                <span class="text-gray-600"><code>rate_limited</code> - Too many requests; retry later</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Snapshot API -->
    <section id="snapshot">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Get Discussion Snapshot</h2>
      <p class="text-gray-600 mb-4">Get participation counts and metadata. Does not include analysis content.</p>

      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
          <code class="text-sm">
            <span class="text-blue-600 font-bold">GET</span>
            <span class="text-gray-900">/api/discussions/{discussion_id}/snapshot</span>
          </code>
        </div>
        <div class="p-4 space-y-4">
          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Path Parameters</h4>
            <div class="overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0">
            <table class="w-full text-sm min-w-[400px]">
              <tr>
                <td class="py-2 font-mono text-purple-600">discussion_id</td>
                <td class="py-2 text-gray-500">required</td>
                <td class="py-2 text-gray-600">The discussion ID</td>
              </tr>
            </table>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Example Request</h4>
            <div class="code-block relative group">
              <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
              <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm whitespace-pre-wrap break-words">curl "{{ base_url }}/api/discussions/123/snapshot"</pre>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Success Response (200)</h4>
            <div class="code-block relative group">
              <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
              <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm whitespace-pre-wrap break-words">{
  "discussion_id": 123,
  "discussion_title": "Should we reform housing policy?",
  "participant_count": 847,
  "statement_count": 12,
  "has_analysis": true,
  "opinion_groups": 3,
  "analyzed_at": "2026-02-05T10:30:00Z",
  "consensus_url": "{{ base_url }}/discussions/123/.../consensus",
  "teaser_text": "Housing reform debate reveals surprising common ground"
}</pre>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">When Analysis Not Ready</h4>
            <div class="code-block relative group">
              <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
              <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm whitespace-pre-wrap break-words">{
  "discussion_id": 123,
  "discussion_title": "Should we reform housing policy?",
  "participant_count": 23,
  "statement_count": 5,
  "has_analysis": false,
  "consensus_url": "{{ base_url }}/discussions/123/.../consensus"
}</pre>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Error Responses</h4>
            <div class="space-y-2 text-sm">
              <div class="flex gap-4">
                <code class="text-red-600">403</code>
                <span class="text-gray-600"><code>partner_disabled</code> - Embed and API access revoked for this partner ref</span>
              </div>
              <div class="flex gap-4">
                <code class="text-red-600">403</code>
                <span class="text-gray-600"><code>forbidden</code> - Valid test API key required for test discussions</span>
              </div>
              <div class="flex gap-4">
                <code class="text-red-600">404</code>
                <span class="text-gray-600"><code>discussion_not_found</code> - Discussion does not exist</span>
              </div>
              <div class="flex gap-4">
                <code class="text-red-600">429</code>
                <span class="text-gray-600"><code>rate_limited</code> - Too many requests; retry later</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Embed URL -->
    <section id="embed-url-parameters">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Embed URL Parameters</h2>
      <p class="text-gray-600 mb-2">Customize the embed appearance with URL parameters.</p>
      <p class="text-sm text-gray-500 mb-4">Embeds are available for Society Speaks native discussions.</p>

      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
          <code class="text-sm text-gray-900">{{ base_url }}/discussions/{discussion_id}/embed</code>
        </div>
        <div class="p-4">
          <div class="overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0">
          <table class="w-full text-sm min-w-[500px]">
            <thead>
              <tr class="border-b">
                <th class="py-2 text-left font-semibold text-gray-900">Parameter</th>
                <th class="py-2 text-left font-semibold text-gray-900">Description</th>
                <th class="py-2 text-left font-semibold text-gray-900">Example</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-b">
                <td class="py-3 font-mono text-purple-600">theme</td>
                <td class="py-3 text-gray-600">Preset theme: <code>default</code>, <code>dark</code>, <code>editorial</code>, <code>minimal</code>, <code>bold</code>, <code>muted</code></td>
                <td class="py-3 font-mono text-gray-500">theme=editorial</td>
              </tr>
              <tr class="border-b">
                <td class="py-3 font-mono text-purple-600">primary</td>
                <td class="py-3 text-gray-600">Primary color (hex without #)</td>
                <td class="py-3 font-mono text-gray-500">primary=1e40af</td>
              </tr>
              <tr class="border-b">
                <td class="py-3 font-mono text-purple-600">bg</td>
                <td class="py-3 text-gray-600">Background color (hex without #)</td>
                <td class="py-3 font-mono text-gray-500">bg=f9fafb</td>
              </tr>
              <tr class="border-b">
                <td class="py-3 font-mono text-purple-600">font</td>
                <td class="py-3 text-gray-600">Font family from allowlist</td>
                <td class="py-3 font-mono text-gray-500">font=Georgia</td>
              </tr>
              <tr>
                <td class="py-3 font-mono text-purple-600">ref</td>
                <td class="py-3 text-gray-600">Partner reference for analytics</td>
                <td class="py-3 font-mono text-gray-500">ref=observer</td>
              </tr>
            </tbody>
          </table>
          </div>

          <div class="mt-4 p-3 bg-blue-50 rounded-lg">
            <p class="text-sm text-blue-800">
              <strong>Allowed fonts:</strong> system-ui, Georgia, Inter, Lato, Open Sans, Source Serif Pro
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Embed: Session Tracking & Privacy -->
    <section id="embed-sessions">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Embed: Session Tracking &amp; Privacy</h2>
      <div class="bg-white border border-gray-200 rounded-lg p-5 space-y-4">
        <p class="text-sm text-gray-700">
          The embed uses a first-party cookie to deduplicate anonymous votes across page loads.
          When the embed is loaded in a cross-domain iframe (the normal case for partner sites),
          browsers with strict privacy settings may block this cookie as a third-party cookie.
        </p>
        <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
          <p class="text-sm text-green-900">
            <strong>No action required.</strong> The embed automatically falls back to a
            <code>localStorage</code>-based session identifier (<code>embed_fingerprint</code>)
            when cookies are unavailable. Vote deduplication works in both modes.
          </p>
        </div>
        <div class="text-sm text-gray-700 space-y-2">
          <p><strong>How it works:</strong></p>
          <ul class="list-disc list-inside space-y-1 text-gray-600">
            <li>The embed generates a random participant ID and stores it in <code>localStorage</code> under the embed origin.</li>
            <li>This ID is sent with each vote as <code>embed_fingerprint</code> for server-side deduplication.</li>
            <li>If the user clears site data or uses private browsing, a new session starts (they can vote again).</li>
            <li>Safari, Firefox, and Brave are fully supported via this fallback.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- PostMessage Events -->
    <section id="postmessage">
      <h2 class="text-xl font-bold text-gray-900 mb-4">PostMessage Events</h2>
      <p class="text-gray-600 mb-4">The embed communicates with the parent frame via postMessage.</p>

      <div class="bg-white border border-gray-200 rounded-lg p-4 space-y-4">
        <div>
          <h4 class="font-semibold text-gray-900 mb-2">societyspeaks:embed:loaded</h4>
          <p class="text-gray-600 text-sm mb-2">Sent when the embed finishes loading.</p>
          <div class="code-block relative group">
            <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
            <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm whitespace-pre-wrap break-words">{
  "type": "societyspeaks:embed:loaded",
  "discussionId": 123,
  "statementCount": 5
}</pre>
          </div>
        </div>

        <div>
          <h4 class="font-semibold text-gray-900 mb-2">societyspeaks:embed:resize</h4>
          <p class="text-gray-600 text-sm mb-2">Sent when the embed content height changes. Use to resize iframe.</p>
          <div class="code-block relative group">
            <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
            <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm whitespace-pre-wrap break-words">{
  "type": "societyspeaks:embed:resize",
  "discussionId": 123,
  "height": 450
}</pre>
          </div>
        </div>

        <div>
          <h4 class="font-semibold text-gray-900 mb-2">Example: Auto-resize iframe</h4>
          <div class="code-block relative group">
            <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
            <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm whitespace-pre-wrap break-words">window.addEventListener('message', (event) => {
  if (event.data.type === 'societyspeaks:embed:resize') {
    const iframe = document.querySelector('iframe[src*="societyspeaks"]');
    if (iframe) iframe.style.height = event.data.height + 'px';
  }
});</pre>
          </div>
        </div>
      </div>
    </section>

    <!-- oEmbed -->
    <section id="oembed">
      <h2 class="text-xl font-bold text-gray-900 mb-4">oEmbed Provider</h2>
      <p class="text-gray-600 mb-4">Enable automatic embedding of Society Speaks discussions in platforms that support oEmbed.</p>

      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
          <code class="text-sm">
            <span class="text-blue-600 font-bold">GET</span>
            <span class="text-gray-900">/api/oembed</span>
          </code>
        </div>
        <div class="p-4 space-y-4">
          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Query Parameters</h4>
            <div class="overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0">
            <table class="w-full text-sm min-w-[400px]">
              <tr class="border-b">
                <td class="py-2 font-mono text-purple-600">url</td>
                <td class="py-2 text-gray-500">required</td>
                <td class="py-2 text-gray-600">Society Speaks discussion URL</td>
              </tr>
              <tr class="border-b">
                <td class="py-2 font-mono text-purple-600">maxwidth</td>
                <td class="py-2 text-gray-500">optional</td>
                <td class="py-2 text-gray-600">Maximum embed width</td>
              </tr>
              <tr class="border-b">
                <td class="py-2 font-mono text-purple-600">maxheight</td>
                <td class="py-2 text-gray-500">optional</td>
                <td class="py-2 text-gray-600">Maximum embed height</td>
              </tr>
              <tr>
                <td class="py-2 font-mono text-purple-600">format</td>
                <td class="py-2 text-gray-500">optional</td>
                <td class="py-2 text-gray-600">Response format (only "json" supported)</td>
              </tr>
            </table>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Example Request</h4>
            <div class="code-block relative group">
              <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
              <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm whitespace-pre-wrap break-words">curl "{{ base_url }}/api/oembed?url={{ base_url }}/discussions/123/my-discussion"</pre>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Success Response (200)</h4>
            <div class="code-block relative group">
              <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
              <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm whitespace-pre-wrap break-words">{
  "type": "rich",
  "version": "1.0",
  "title": "Should we reform housing policy?",
  "provider_name": "Society Speaks",
  "provider_url": "{{ base_url }}",
  "html": "&lt;iframe src=\"{{ base_url }}/discussions/123/embed\" ...&gt;&lt;/iframe&gt;",
  "width": 600,
  "height": 400,
  "cache_age": 3600
}</pre>
            </div>
          </div>

          <div class="p-3 bg-blue-50 rounded-lg">
            <p class="text-sm text-blue-800">
              <strong>Auto-discovery:</strong> Discussion pages include a <code>&lt;link rel="alternate" type="application/json+oembed"&gt;</code> tag for automatic oEmbed discovery by compatible platforms.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Create Discussion API -->
    <section id="create-discussion">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Create Discussion (Authenticated)</h2>
      <p class="text-gray-600 mb-4">Create a discussion for an article not ingested via RSS. Requires API key.</p>

      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
          <code class="text-sm">
            <span class="text-green-600 font-bold">POST</span>
            <span class="text-gray-900">/api/partner/discussions</span>
          </code>
        </div>
        <div class="p-4 space-y-4">
          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Headers</h4>
            <div class="overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0">
            <table class="w-full text-sm min-w-[400px]">
              <tr class="border-b">
                <td class="py-2 font-mono text-purple-600">X-API-Key</td>
                <td class="py-2 text-gray-500">required</td>
                <td class="py-2 text-gray-600">Your partner API key</td>
              </tr>
              <tr>
                <td class="py-2 font-mono text-purple-600">Content-Type</td>
                <td class="py-2 text-gray-500">required</td>
                <td class="py-2 text-gray-600">application/json</td>
              </tr>
            </table>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Request Body</h4>
            <div class="overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0">
            <table class="w-full text-sm min-w-[400px]">
              <tr class="border-b">
                <td class="py-2 font-mono text-purple-600">article_url</td>
                <td class="py-2 text-gray-500">required</td>
                <td class="py-2 text-gray-600">The article URL (will be normalized)</td>
              </tr>
              <tr class="border-b">
                <td class="py-2 font-mono text-purple-600">title</td>
                <td class="py-2 text-gray-500">required</td>
                <td class="py-2 text-gray-600">Discussion title (max 200 chars)</td>
              </tr>
              <tr class="border-b">
                <td class="py-2 font-mono text-purple-600">excerpt</td>
                <td class="py-2 text-gray-500">conditional</td>
                <td class="py-2 text-gray-600">Article excerpt for AI-generated statements</td>
              </tr>
              <tr class="border-b">
                <td class="py-2 font-mono text-purple-600">seed_statements</td>
                <td class="py-2 text-gray-500">conditional</td>
                <td class="py-2 text-gray-600">Array of {content, position} statements</td>
              </tr>
              <tr>
                <td class="py-2 font-mono text-purple-600">source_name</td>
                <td class="py-2 text-gray-500">optional</td>
                <td class="py-2 text-gray-600">Your publication name for attribution</td>
              </tr>
            </table>
            </div>
            <p class="text-xs text-gray-500 mt-2">Note: Either <code>excerpt</code> or <code>seed_statements</code> must be provided.</p>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Example Request</h4>
            <div class="code-block relative group">
              <button class="copy-btn absolute top-10 right-2 z-10 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
              <div class="rounded-lg border border-gray-700 overflow-hidden ss-code-tabs">
                <div class="flex bg-gray-800 border-b border-gray-700 text-xs" role="tablist">
                  <button role="tab" aria-selected="true" data-lang="curl" class="ss-tab px-3 py-2 font-medium transition-colors text-white bg-gray-900">curl</button>
                  <button role="tab" aria-selected="false" data-lang="python" class="ss-tab px-3 py-2 font-medium transition-colors text-gray-400 hover:text-gray-200">Python</button>
                  <button role="tab" aria-selected="false" data-lang="node" class="ss-tab px-3 py-2 font-medium transition-colors text-gray-400 hover:text-gray-200">Node.js</button>
                </div>
                <pre class="bg-gray-900 text-green-400 p-3 text-sm whitespace-pre-wrap break-words ss-panel" data-lang="curl">curl -X POST "{{ base_url }}/api/partner/discussions" \
  -H "X-API-Key: your_api_key" \
  -H "Content-Type: application/json" \
  -d '{
    "article_url": "https://example.com/article/urban-cars",
    "title": "Should cities ban cars from downtown areas?",
    "excerpt": "A new study shows that car-free zones improve air quality...",
    "source_name": "Example News"
  }'</pre>
                <pre class="bg-gray-900 text-green-400 p-3 text-sm whitespace-pre-wrap break-words ss-panel" data-lang="python" hidden>import requests

resp = requests.post(
    "{{ base_url }}/api/partner/discussions",
    headers={
        "X-API-Key": "your_api_key",
        "Content-Type": "application/json",
    },
    json={
        "article_url": "https://example.com/article/urban-cars",
        "title": "Should cities ban cars from downtown areas?",
        "excerpt": "A new study shows that car-free zones improve air quality...",
        "source_name": "Example News",
    },
)
data = resp.json()
discussion_id = data["discussion_id"]
embed_url = data["embed_url"]</pre>
                <pre class="bg-gray-900 text-green-400 p-3 text-sm whitespace-pre-wrap break-words ss-panel" data-lang="node" hidden>const resp = await fetch("{{ base_url }}/api/partner/discussions", {
  method: "POST",
  headers: {
    "X-API-Key": "your_api_key",
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    article_url: "https://example.com/article/urban-cars",
    title: "Should cities ban cars from downtown areas?",
    excerpt: "A new study shows that car-free zones improve air quality...",
    source_name: "Example News",
  }),
});
const data = await resp.json();
const { discussion_id, embed_url } = data;</pre>
              </div>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Success Response (201)</h4>
            <div class="code-block relative group">
              <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
              <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm whitespace-pre-wrap break-words">{
  "discussion_id": 456,
  "slug": "should-cities-ban-cars-from-downtown-areas",
  "title": "Should cities ban cars from downtown areas?",
  "embed_url": "{{ base_url }}/discussions/456/embed",
  "consensus_url": "{{ base_url }}/discussions/456/.../consensus",
  "snapshot_url": "{{ base_url }}/api/discussions/456/snapshot",
  "source": "partner",
  "env": "live",
  "statement_count": 5
}</pre>
            </div>
          </div>

          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Error Responses</h4>
            <div class="space-y-2 text-sm">
              <div class="flex gap-4">
                <code class="text-red-600">401</code>
                <span class="text-gray-600"><code>invalid_api_key</code> - Missing or invalid API key</span>
              </div>
              <div class="flex gap-4">
                <code class="text-red-600">400</code>
                <span class="text-gray-600"><code>missing_content</code> - Need excerpt or seed_statements</span>
              </div>
              <div class="flex gap-4">
                <code class="text-red-600">409</code>
                <span class="text-gray-600"><code>discussion_exists</code> - Discussion already exists for URL</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Cost and abuse protection -->
    <section id="cost-protection">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Cost and Abuse Protection</h2>
      <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
        <p class="text-amber-900 text-sm mb-3">
          <strong>Who pays for what:</strong> Lookup, snapshot, oEmbed, and the embed page do not use our LLM. They are rate-limited per IP (and optional <code>ref</code>) to prevent abuse. <strong>Create Discussion</strong> is the only endpoint that can trigger AI-generated seed statements (OpenAI/Anthropic); it uses <em>our</em> API keys, not yours.
        </p>
        <p class="text-amber-900 text-sm mb-3">
          <strong>Partners use keys we issue.</strong> Only requests with a valid <code>X-API-Key</code> (from our allowlist) can create discussions. We do not use partner-provided LLM keys for the create flow. If a key is abused, we revoke it.
        </p>
        <p class="text-amber-900 text-sm">
          <strong>Create Discussion</strong> is limited to <strong>30 requests per hour per API key</strong>. Combined with key control, this caps LLM and database cost from the create endpoint.
        </p>
      </div>
    </section>

    <!-- Rate Limits -->
    <section id="rate-limits">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Rate Limits</h2>
      <div class="bg-white border border-gray-200 rounded-lg p-4">
        <div class="overflow-x-auto -mx-4 px-4 sm:mx-0 sm:px-0">
        <table class="w-full text-sm min-w-[400px]">
          <thead>
            <tr class="border-b">
              <th class="py-2 text-left font-semibold text-gray-900">Endpoint</th>
              <th class="py-2 text-left font-semibold text-gray-900">Limit</th>
            </tr>
          </thead>
          <tbody>
            <tr class="border-b">
              <td class="py-3 text-gray-600">Lookup by article URL</td>
              <td class="py-3 font-mono text-gray-900">60 req / min / IP</td>
            </tr>
            <tr class="border-b">
              <td class="py-3 text-gray-600">Get snapshot</td>
              <td class="py-3 font-mono text-gray-900">120 req / min / IP</td>
            </tr>
            <tr class="border-b">
              <td class="py-3 text-gray-600">Vote submission (default)</td>
              <td class="py-3 font-mono text-gray-900">30 req / min / IP</td>
            </tr>
            <tr class="border-b">
              <td class="py-3 text-gray-600">Vote submission (integrity mode)</td>
              <td class="py-3 font-mono text-gray-900">10 req / min / discussion</td>
            </tr>
            <tr class="border-b">
              <td class="py-3 text-gray-600">Statement creation (authenticated)</td>
              <td class="py-3 font-mono text-gray-900">10 per hour</td>
            </tr>
            <tr class="border-b">
              <td class="py-3 text-gray-600">Statement creation (anonymous)</td>
              <td class="py-3 font-mono text-gray-900">5 per hour</td>
            </tr>
            <tr class="border-b">
              <td class="py-3 text-gray-600">Flag statement (from embed)</td>
              <td class="py-3 font-mono text-gray-900">10 req / min / IP</td>
            </tr>
            <tr>
              <td class="py-3 text-gray-600">Create discussion</td>
              <td class="py-3 font-mono text-gray-900">30 req / hr / key</td>
            </tr>
          </tbody>
        </table>
        </div>
        <p class="text-sm text-gray-500 mt-4">
          Responses include a <code>429 Too Many Requests</code> with a <code>Retry-After</code> header indicating
          seconds until the next request is allowed.
        </p>
        <p class="text-sm text-gray-500 mt-2">
          <strong>Integrity mode:</strong> Some discussions have stricter vote rate limits enabled for integrity protection.
          The embed handles this transparently &mdash; users see a &ldquo;please slow down&rdquo; message.
        </p>
      </div>
    </section>

    <!-- Error Format -->
    <section id="error-format">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Error Format</h2>
      <p class="text-gray-600 mb-4">All errors return JSON with a consistent format.</p>
      <div class="code-block relative group">
        <button class="copy-btn absolute top-2 right-2 rounded bg-gray-700 px-2 py-1 text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-600 hover:text-white">Copy</button>
        <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm whitespace-pre-wrap break-words">{
  "error": "error_code",
  "message": "Human-readable description of the error"
}</pre>
      </div>
    </section>
    </div><!-- /lg:col-span-9 -->
  </div><!-- /lg:grid -->

  <!-- Footer -->
  <div class="mt-12 pt-8 border-t border-gray-200">
    <p class="text-gray-500 text-sm">
      Questions? <a href="mailto:info@societyspeaks.io" class="text-blue-600 hover:underline">Contact us</a>
      or visit the <a href="{{ url_for('partner.hub') }}" class="text-blue-600 hover:underline">Partner Hub</a>.
    </p>
  </div>
</div>

<script>
  // Language tab switching for code examples
  // Remembers the selected language across all tab groups on the page
  (function() {
    let currentLang = localStorage.getItem('ss_api_lang') || 'curl';

    function activateTab(container, lang) {
      container.querySelectorAll('.ss-tab').forEach(function(btn) {
        const isActive = btn.dataset.lang === lang;
        btn.setAttribute('aria-selected', isActive);
        btn.classList.toggle('text-white', isActive);
        btn.classList.toggle('bg-gray-900', isActive);
        btn.classList.toggle('text-gray-400', !isActive);
      });
      container.querySelectorAll('.ss-panel').forEach(function(panel) {
        panel.hidden = panel.dataset.lang !== lang;
      });
    }

    // Initialize all tab groups
    document.querySelectorAll('.ss-code-tabs').forEach(function(container) {
      activateTab(container, currentLang);

      container.querySelectorAll('.ss-tab').forEach(function(btn) {
        btn.addEventListener('click', function() {
          currentLang = btn.dataset.lang;
          localStorage.setItem('ss_api_lang', currentLang);
          // Sync all tab groups on the page
          document.querySelectorAll('.ss-code-tabs').forEach(function(c) {
            activateTab(c, currentLang);
          });
        });
      });
    });
  })();

  // Scroll-spy: highlight current section in sidebar
  (function() {
    var links = document.querySelectorAll('.docs-nav-link');
    if (!links.length) return;

    var sections = [];
    links.forEach(function(link) {
      var id = link.getAttribute('href').slice(1);
      var el = document.getElementById(id);
      if (el) sections.push({ id: id, el: el, link: link });
    });

    var activeClass = ['bg-blue-50', 'text-blue-700', 'font-semibold'];
    var inactiveClass = ['text-gray-600'];

    function highlight(activeId) {
      sections.forEach(function(s) {
        if (s.id === activeId) {
          inactiveClass.forEach(function(c) { s.link.classList.remove(c); });
          activeClass.forEach(function(c) { s.link.classList.add(c); });
        } else {
          activeClass.forEach(function(c) { s.link.classList.remove(c); });
          inactiveClass.forEach(function(c) { s.link.classList.add(c); });
        }
      });
    }

    var ticking = false;
    function onScroll() {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(function() {
        var scrollY = window.scrollY + 100;
        var current = sections[0] ? sections[0].id : '';
        for (var i = sections.length - 1; i >= 0; i--) {
          if (sections[i].el.offsetTop <= scrollY) {
            current = sections[i].id;
            break;
          }
        }
        highlight(current);
        ticking = false;
      });
    }
    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll();
  })();
</script>
{% endblock %}
