{#
Listen With Dropdown Component

Provides multiple ways to listen to content:
1. Native audio (if XTTS audio exists)
2. Browser TTS (speechSynthesis API)
3. Share to reader apps (ElevenReader, Pocket, etc.)

URLs and title are passed via data attributes (no inline user content in handlers).

Usage:
  {{ listen_with(has_audio=True, audio_url='/audio/file.wav', reader_url='/brief/2025-01-29/reader', brief_title='Brief') }}

Parameters:
  - has_audio: Boolean - whether native XTTS audio is available
  - audio_url: String - URL to the first audio file (for quick play)
  - reader_url: String - URL to the reader-optimized version of the page
  - brief_title: String - title for sharing
#}

{% macro listen_with(has_audio=False, audio_url=None, reader_url=None, brief_title='Brief') %}
<div class="listen-with-container relative"
     data-reader-url="{{ (reader_url or request.url)|e }}"
     data-brief-title="{{ brief_title|e }}"
     {% if has_audio and audio_url %}data-audio-url="{{ audio_url|e }}"{% endif %}>

    <button type="button"
            aria-haspopup="true"
            aria-expanded="false"
            class="inline-flex items-center gap-2 px-4 py-2.5 min-h-[44px] sm:min-h-0 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors touch-manipulation">
        <svg class="w-5 h-5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
        </svg>
        <span>Listen with...</span>
        <svg class="w-4 h-4 text-gray-400 listen-chevron transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
    </button>

    <!-- Dropdown Menu -->
    <div class="listen-menu hidden absolute left-0 z-50 mt-2 w-72 max-w-[calc(100vw-2rem)] origin-top-left rounded-xl bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
         role="menu">
        <div class="p-2">
            {% if has_audio and audio_url %}
            <!-- Native Audio -->
            <button type="button"
                    data-action="native-audio"
                    class="listen-menu-item flex items-center gap-3 w-full px-3 py-2.5 min-h-[44px] sm:min-h-0 text-left text-sm text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-700 transition-colors touch-manipulation"
                    role="menuitem">
                <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex-shrink-0">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                </span>
                <div class="min-w-0">
                    <p class="font-medium">Native Audio</p>
                    <p class="text-xs text-gray-500">Play generated audio</p>
                </div>
            </button>
            {% endif %}

            <!-- Browser Read Aloud -->
            <button type="button"
                    data-action="browser-tts"
                    class="browser-tts-btn listen-menu-item flex items-center gap-3 w-full px-3 py-2.5 min-h-[44px] sm:min-h-0 text-left text-sm text-gray-700 rounded-lg hover:bg-gray-50 transition-colors touch-manipulation"
                    role="menuitem">
                <span class="tts-icon flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-gray-600 flex-shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </span>
                <div class="min-w-0">
                    <p class="font-medium tts-label">Browser Read Aloud</p>
                    <p class="text-xs text-gray-500">Use your browser's voice</p>
                </div>
            </button>

            <div class="my-2 border-t border-gray-100" aria-hidden="true"></div>
            <p class="px-3 py-1 text-xs font-semibold text-gray-400 uppercase tracking-wider">Open in Reader App</p>

            <!-- ElevenReader -->
            <button type="button"
                    data-action="elevenreader"
                    class="listen-menu-item flex items-center gap-3 w-full px-3 py-2.5 min-h-[44px] sm:min-h-0 text-left text-sm text-gray-700 rounded-lg hover:bg-gray-50 transition-colors touch-manipulation"
                    role="menuitem">
                <span class="flex items-center justify-center w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex-shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                    </svg>
                </span>
                <div class="min-w-0">
                    <p class="font-medium">ElevenReader</p>
                    <p class="text-xs text-gray-500">AI voice narration</p>
                </div>
            </button>

            <!-- Pocket -->
            <button type="button"
                    data-action="pocket"
                    class="listen-menu-item flex items-center gap-3 w-full px-3 py-2.5 min-h-[44px] sm:min-h-0 text-left text-sm text-gray-700 rounded-lg hover:bg-gray-50 transition-colors touch-manipulation"
                    role="menuitem">
                <span class="flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-600 flex-shrink-0">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M18.813 5.104H5.187A2.19 2.19 0 003 7.29v5.478c0 5.033 4.003 9.232 9 9.232s9-4.199 9-9.232V7.29a2.19 2.19 0 00-2.187-2.186zm-2.57 6.185l-3.59 3.467a.912.912 0 01-1.306 0l-3.59-3.467a.916.916 0 011.306-1.287L12 12.847l2.937-2.845a.916.916 0 111.306 1.287z" />
                    </svg>
                </span>
                <div class="min-w-0">
                    <p class="font-medium">Pocket</p>
                    <p class="text-xs text-gray-500">Save & listen later</p>
                </div>
            </button>

            <!-- Instapaper -->
            <button type="button"
                    data-action="instapaper"
                    class="listen-menu-item flex items-center gap-3 w-full px-3 py-2.5 min-h-[44px] sm:min-h-0 text-left text-sm text-gray-700 rounded-lg hover:bg-gray-50 transition-colors touch-manipulation"
                    role="menuitem">
                <span class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-800 text-white flex-shrink-0">
                    <span class="text-xs font-bold">Ip</span>
                </span>
                <div class="min-w-0">
                    <p class="font-medium">Instapaper</p>
                    <p class="text-xs text-gray-500">Clean reading experience</p>
                </div>
            </button>

            <!-- Share / Copy Link -->
            <button type="button"
                    data-action="native"
                    class="listen-menu-item flex items-center gap-3 w-full px-3 py-2.5 min-h-[44px] sm:min-h-0 text-left text-sm text-gray-700 rounded-lg hover:bg-gray-50 transition-colors touch-manipulation"
                    role="menuitem">
                <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex-shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                </span>
                <div class="min-w-0">
                    <p class="font-medium">Share / Copy Link</p>
                    <p class="text-xs text-gray-500">Open in any reader app</p>
                </div>
            </button>
        </div>
    </div>
</div>
{% endmacro %}
