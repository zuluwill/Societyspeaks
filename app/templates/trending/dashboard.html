{% extends 'layout.html' %}

{% block title %}Trending Topics - Admin{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Trending Topics</h1>
        <p class="text-gray-600 mt-2">News-to-Deliberation Compiler - Manage trending topics from curated news sources</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-500">Pending Review</div>
            <div class="text-2xl font-bold text-yellow-600">{{ stats.topics.pending_review }}</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-500">Published</div>
            <div class="text-2xl font-bold text-green-600">{{ stats.topics.published }}</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-500">Articles (24h)</div>
            <div class="text-2xl font-bold text-blue-600">{{ stats.articles.last_24h }}</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-500">Active Sources</div>
            <div class="text-2xl font-bold text-purple-600">{{ stats.sources.active }}</div>
        </div>
    </div>

    <!-- Social Media Posting Status -->
    <div class="bg-white rounded-lg shadow mb-8">
        <div class="p-4 border-b">
            <h2 class="text-xl font-semibold">Social Media Posting Status</h2>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Bluesky Status -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.5 14.5c-1.5 0-2.75-.83-3.5-2-.75 1.17-2 2-3.5 2-2.21 0-4-1.79-4-4 0-3 2.5-6 7.5-9 5 3 7.5 6 7.5 9 0 2.21-1.79 4-4 4z"/>
                        </svg>
                        <span class="font-medium">Bluesky</span>
                        {% if social_status.bluesky.configured %}
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded">Configured</span>
                        {% else %}
                        <span class="bg-red-100 text-red-800 text-xs px-2 py-0.5 rounded">Not Configured</span>
                        {% endif %}
                    </div>
                    <div class="text-sm text-gray-600">
                        <p>Handle: <span class="font-mono">{{ social_status.bluesky.handle }}</span></p>
                    </div>
                </div>

                <!-- X/Twitter Status -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-5 h-5 text-gray-900" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        <span class="font-medium">X (Twitter)</span>
                        {% if social_status.x.configured %}
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded">Configured</span>
                        {% else %}
                        <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded">Awaiting Setup</span>
                        {% endif %}
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p>Handle: <span class="font-mono">{{ social_status.x.handle }}</span></p>
                        {% if social_status.x.configured %}
                        <div class="mt-3 pt-3 border-t">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-500">Today:</span>
                                <span class="font-medium {% if social_status.x.is_rate_limited %}text-red-600{% else %}text-green-600{% endif %}">
                                    {{ social_status.x.posts_today }}/{{ social_status.x.daily_limit }} posts
                                </span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-500">This Month:</span>
                                <span class="font-medium {% if social_status.x.approaching_monthly_limit %}text-orange-600{% else %}text-green-600{% endif %}">
                                    {{ social_status.x.posts_this_month }}/{{ social_status.x.monthly_limit }} ({{ social_status.x.monthly_usage_percent }}%)
                                </span>
                            </div>
                            <!-- Progress bar for monthly usage -->
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="h-2 rounded-full {% if social_status.x.monthly_usage_percent >= 90 %}bg-red-500{% elif social_status.x.monthly_usage_percent >= 70 %}bg-orange-500{% else %}bg-green-500{% endif %}" 
                                     style="width: {{ social_status.x.monthly_usage_percent }}%"></div>
                            </div>
                            {% if social_status.x.is_rate_limited %}
                            <div class="mt-3 bg-red-50 border border-red-200 rounded p-2 text-red-700 text-xs">
                                ⚠️ {{ social_status.x.rate_limit_reason }}
                            </div>
                            {% endif %}
                            {% if social_status.x.approaching_monthly_limit %}
                            <div class="mt-3 bg-orange-50 border border-orange-200 rounded p-2 text-orange-700 text-xs">
                                ⚠️ Approaching monthly limit ({{ social_status.x.monthly_remaining }} posts remaining)
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <p class="mt-2 text-gray-400 text-xs">
                            Add X_API_KEY, X_API_SECRET, X_ACCESS_TOKEN, X_ACCESS_TOKEN_SECRET to environment variables.
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex flex-wrap gap-4 mb-8">
        <form action="{{ url_for('trending.trigger_pipeline') }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                Run Pipeline Now
            </button>
        </form>
        <form action="{{ url_for('trending.process_pending') }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                Process Pending Topics
            </button>
        </form>
        <a href="{{ url_for('trending.view_articles') }}" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
            View Articles
        </a>
        <a href="{{ url_for('trending.manage_sources') }}" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
            Manage Sources
        </a>
        <form action="{{ url_for('trending.clean_summaries') }}" method="post" 
              onsubmit="return confirm('This will clean promotional content from all article summaries and topic descriptions. Continue?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700">
                Clean Summaries
            </button>
        </form>
    </div>

    <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b">
            <h2 class="text-xl font-semibold">Review Queue</h2>
        </div>
        
        {% if queue.items %}
        <div class="divide-y">
            {% for topic in queue.items %}
            <div class="p-4 hover:bg-gray-50">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <a href="{{ url_for('trending.view_topic', topic_id=topic.id) }}" class="text-lg font-medium text-blue-600 hover:underline">
                            {{ topic.title }}
                        </a>
                        <div class="flex gap-4 mt-2 text-sm text-gray-500">
                            <span>{{ topic.source_count }} sources</span>
                            <span class="{% if topic.civic_score and topic.civic_score >= 0.7 %}text-green-600{% endif %}">
                                Civic: {{ "%.0f"|format((topic.civic_score or 0) * 100) }}%
                            </span>
                            <span class="{% if topic.quality_score and topic.quality_score >= 0.7 %}text-green-600{% endif %}">
                                Quality: {{ "%.0f"|format((topic.quality_score or 0) * 100) }}%
                            </span>
                            {% if topic.risk_flag %}
                            <span class="text-red-600 font-medium">RISK: {{ topic.risk_reason or 'Flagged' }}</span>
                            {% endif %}
                        </div>
                        {% if topic.canonical_tags %}
                        <div class="flex gap-2 mt-2">
                            {% for tag in topic.canonical_tags[:5] %}
                            <span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex gap-2 ml-4">
                        {% if topic.should_auto_publish %}
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Auto-Publish Eligible</span>
                        {% endif %}
                        <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">{{ topic.status }}</span>
                    </div>
                </div>
                <div class="mt-2 text-sm text-gray-400">
                    Created: {{ topic.created_at.strftime('%Y-%m-%d %H:%M') }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% if queue.pages > 1 %}
        <div class="p-4 border-t bg-gray-50 flex items-center justify-between">
            <div class="text-sm text-gray-600">
                Showing {{ queue.items|length }} of {{ queue.total }} pending topics
            </div>
            <div class="flex gap-2">
                {% if queue.has_prev %}
                <a href="{{ url_for('trending.dashboard', page=queue.prev_num) }}"
                   class="px-3 py-1.5 text-sm rounded border border-gray-300 bg-white hover:bg-gray-100">
                    Previous
                </a>
                {% endif %}
                <span class="px-3 py-1.5 text-sm rounded border border-gray-200 bg-white text-gray-700">
                    Page {{ queue.page }} of {{ queue.pages }}
                </span>
                {% if queue.has_next %}
                <a href="{{ url_for('trending.dashboard', page=queue.next_num) }}"
                   class="px-3 py-1.5 text-sm rounded border border-gray-300 bg-white hover:bg-gray-100">
                    Next
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% else %}
        <div class="p-8 text-center text-gray-500">
            <p>No topics pending review.</p>
            <p class="mt-2">Click "Run Pipeline Now" to fetch and process new articles.</p>
        </div>
        {% endif %}
    </div>

    {% if hot_topics %}
    <div class="mt-8 bg-white rounded-lg shadow">
        <div class="p-4 border-b">
            <h2 class="text-xl font-semibold">Trending in Premium Sources</h2>
            <p class="text-sm text-gray-500 mt-1">Topics being discussed by The Economist, FT, UnHerd, podcasts, etc. Click to filter articles.</p>
        </div>
        <div class="p-4">
            <div class="flex flex-wrap gap-2">
                {% for topic in hot_topics %}
                <a href="{{ url_for('trending.view_articles', keyword=topic.keyword) }}" 
                   class="inline-flex items-center gap-1 bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full hover:bg-blue-200 transition-colors cursor-pointer">
                    {{ topic.keyword }}
                    <span class="bg-blue-200 text-blue-900 text-xs px-1.5 py-0.5 rounded-full">{{ topic.mentions }}</span>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="mt-8 bg-white rounded-lg shadow">
        <div class="p-4 border-b">
            <h2 class="text-xl font-semibold">All Topics Summary</h2>
        </div>
        <div class="p-4 grid grid-cols-5 gap-4 text-center">
            <div>
                <div class="text-2xl font-bold">{{ stats.topics.pending }}</div>
                <div class="text-sm text-gray-500">Pending</div>
            </div>
            <div>
                <div class="text-2xl font-bold text-yellow-600">{{ stats.topics.pending_review }}</div>
                <div class="text-sm text-gray-500">Review</div>
            </div>
            <div>
                <div class="text-2xl font-bold text-green-600">{{ stats.topics.published }}</div>
                <div class="text-sm text-gray-500">Published</div>
            </div>
            <div>
                <div class="text-2xl font-bold text-blue-600">{{ stats.topics.merged }}</div>
                <div class="text-sm text-gray-500">Merged</div>
            </div>
            <div>
                <div class="text-2xl font-bold text-gray-400">{{ stats.topics.discarded }}</div>
                <div class="text-sm text-gray-500">Discarded</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
