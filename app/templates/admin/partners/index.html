{% extends "layout.html" %}

{% block title %}Partners - Admin{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold text-gray-900 mb-6">Partners</h1>
  <div class="mb-6 flex flex-wrap items-center gap-2">
    <a href="{{ url_for('partner.portal_signup') }}" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
      Open partner signup flow
    </a>
    {% if session.get('partner_admin_preview') %}
    <form method="POST" action="{{ url_for('admin.stop_partner_preview') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
        End active preview session
      </button>
    </form>
    {% endif %}
  </div>

  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Organizations</h2>
    <div class="space-y-3">
      {% for partner in partners %}
      <div class="border rounded-lg p-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <div class="font-semibold text-gray-900">{{ partner.name }}</div>
          <div class="text-sm text-gray-600 break-all">{{ partner.contact_email }} · {{ partner.slug }}</div>
        </div>
        <div class="text-sm text-gray-600">
          Billing: <strong>{{ partner.billing_status }}</strong>
          <span class="mx-1">·</span>
          Tier: <strong>{{ partner.tier }}</strong>
          <span class="mx-1">·</span>
          Team: <strong>{{ member_counts.get(partner.id, 0) }}</strong>
          <span class="mx-1">·</span>
          Creates: <strong>{{ usage_by_partner.get(partner.id, {}).get('create', 0) }}</strong>
        </div>
        <form method="POST" action="{{ url_for('admin.preview_partner_portal', partner_id=partner.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="inline-flex items-center rounded-md bg-white px-3 py-2 text-xs font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
            View portal as partner (read-only)
          </button>
        </form>
      </div>
      {% else %}
      <p class="text-sm text-gray-500">No partners yet.</p>
      {% endfor %}
    </div>
  </div>

  <div class="grid gap-6 lg:grid-cols-3">
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Domains</h2>
      <div class="space-y-2">
        {% for domain in domains %}
        <div class="border rounded-lg p-3">
          <div class="font-semibold text-gray-900">{{ domain.domain }}</div>
          <div class="text-sm text-gray-600">{{ domain.env|upper }} · {{ 'Verified' if domain.is_verified() else 'Unverified' }} · {{ 'Active' if domain.is_active else 'Inactive' }}</div>
        </div>
        {% else %}
        <p class="text-sm text-gray-500">No domains yet.</p>
        {% endfor %}
      </div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">API Keys</h2>
      <div class="space-y-2">
        {% for key in keys %}
        <div class="border rounded-lg p-3">
          <div class="font-mono text-sm text-gray-900">{{ key.key_prefix }}••••{{ key.key_last4 }}</div>
          <div class="text-sm text-gray-600">{{ key.env|upper }} · {{ key.status|upper }}</div>
        </div>
        {% else %}
        <p class="text-sm text-gray-500">No keys yet.</p>
        {% endfor %}
      </div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Team Members</h2>
      <div class="space-y-2">
        {% for member in members %}
        <div class="border rounded-lg p-3">
          <div class="font-semibold text-gray-900 break-all">{{ member.email }}</div>
          <div class="text-sm text-gray-600">{{ member.role|upper }} · {{ member.status|upper }} · Partner #{{ member.partner_id }}</div>
        </div>
        {% else %}
        <p class="text-sm text-gray-500">No team members yet.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow p-6 mt-6">
    <h2 class="text-xl font-semibold mb-4">Admin Preview Audit</h2>
    <div class="space-y-2">
      {% for event in audit_events %}
      <div class="border rounded-lg p-3 flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
        <div class="text-sm text-gray-800">
          <strong>{{ event.action }}</strong>
          {% if event.target_type %} · {{ event.target_type }} #{{ event.target_id }}{% endif %}
        </div>
        <div class="text-xs text-gray-500 break-all">
          admin={{ event.admin_user_id or 'unknown' }} · ip={{ event.request_ip or 'n/a' }} · {{ event.created_at.strftime('%Y-%m-%d %H:%M:%S') if event.created_at else '' }} UTC
        </div>
      </div>
      {% else %}
      <p class="text-sm text-gray-500">No audit events yet.</p>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
