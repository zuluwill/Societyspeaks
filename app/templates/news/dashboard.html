{% extends "layout.html" %}

{% block title %}News Transparency Dashboard - Society Speaks{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-gradient-to-r from-blue-800 to-blue-600 text-white py-12 px-4">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-bold mb-2">News Transparency Dashboard</h1>
        <p class="text-xl text-blue-100">{{ today.strftime('%A, %B %d, %Y') }}</p>
        <p class="text-lg text-blue-200 mt-2">
            {{ total_topics }} {% if total_topics == 1 %}story{% else %}stories{% endif %} from across the political spectrum
        </p>
    </div>
</div>

<!-- Filter Bar -->
<div class="bg-white border-b sticky top-0 z-10 shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex flex-wrap gap-3">
            <button onclick="filterTopics('all')" data-filter="all"
                    class="filter-btn px-6 py-2 rounded-lg font-medium transition-all bg-blue-600 text-white">
                All Sources ({{ total_topics }})
            </button>
            <button onclick="filterTopics('left')" data-filter="left"
                    class="filter-btn px-6 py-2 rounded-lg font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">
                Left-leaning ({{ left_topics|length }})
            </button>
            <button onclick="filterTopics('center')" data-filter="center"
                    class="filter-btn px-6 py-2 rounded-lg font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">
                Center ({{ center_topics|length }})
            </button>
            <button onclick="filterTopics('right')" data-filter="right"
                    class="filter-btn px-6 py-2 rounded-lg font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">
                Right-leaning ({{ right_topics|length }})
            </button>
        </div>
    </div>
</div>

<!-- Topic Grid -->
<div class="max-w-6xl mx-auto px-4 py-8">
    {% if topics %}
    <div class="grid grid-cols-1 gap-6" id="topics-grid">
        {% for item in topics %}
        <div class="topic-card bg-white rounded-lg shadow-lg p-6 border border-gray-200"
             data-leaning="{{ item.dominant_leaning }}">

            <!-- Badges -->
            <div class="flex flex-wrap gap-2 mb-4">
                {% if item.source == 'brief' %}
                <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full">
                    In Today's Brief
                </span>
                {% endif %}

                {% if item.topic.primary_topic %}
                <span class="inline-block bg-gray-100 text-gray-800 text-xs font-semibold px-3 py-1 rounded-full uppercase">
                    {{ item.topic.primary_topic }}
                </span>
                {% endif %}

                <!-- Civic Score Badge -->
                {% if item.civic_score is not none %}
                {% set civic_pct = (item.civic_score * 100)|int %}
                {% if civic_pct >= 70 %}
                <span class="inline-block bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-full">
                    Civic Score: {{ civic_pct }}%
                </span>
                {% elif civic_pct >= 50 %}
                <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full">
                    Civic Score: {{ civic_pct }}%
                </span>
                {% else %}
                <span class="inline-block bg-gray-100 text-gray-800 text-xs font-semibold px-3 py-1 rounded-full">
                    Civic Score: {{ civic_pct }}%
                </span>
                {% endif %}
                {% endif %}

                <!-- Sensationalism Badge -->
                {% if item.sensationalism == 'low' %}
                <span class="inline-block bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-full">
                    Low Sensationalism
                </span>
                {% elif item.sensationalism == 'medium' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 text-xs font-semibold px-3 py-1 rounded-full">
                    Medium Sensationalism
                </span>
                {% elif item.sensationalism == 'high' %}
                <span class="inline-block bg-red-100 text-red-800 text-xs font-semibold px-3 py-1 rounded-full">
                    High Sensationalism
                </span>
                {% endif %}
            </div>

            <!-- Headline -->
            <h3 class="text-2xl font-bold text-gray-900 mb-4">{{ item.headline }}</h3>

            <!-- Coverage Bar -->
            {% set dist = item.coverage.distribution %}
            {% set left_pct = (dist.left * 100)|int %}
            {% set center_pct = (dist.center * 100)|int %}
            {% set right_pct = (dist.right * 100)|int %}
            {% set total_pct = left_pct + center_pct + right_pct %}

            {% if total_pct > 0 %}
            <div class="mb-4">
                <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Coverage Balance</p>

                <!-- Coverage Bar -->
                <div class="w-full h-3 rounded-full overflow-hidden mb-2" style="display: flex; background-color: #e5e7eb;">
                    {% if left_pct > 0 %}
                    <div style="width: {{ left_pct }}%; background-color: #3b82f6; height: 100%;"></div>
                    {% endif %}
                    {% if center_pct > 0 %}
                    <div style="width: {{ center_pct }}%; background-color: #a855f7; height: 100%;"></div>
                    {% endif %}
                    {% if right_pct > 0 %}
                    <div style="width: {{ right_pct }}%; background-color: #ef4444; height: 100%;"></div>
                    {% endif %}
                </div>

                <div class="flex justify-between text-xs">
                    <span class="text-blue-600 font-medium">{{ left_pct }}% Left</span>
                    <span class="text-purple-600 font-medium">{{ center_pct }}% Center</span>
                    <span class="text-red-600 font-medium">{{ right_pct }}% Right</span>
                </div>

                <!-- Sources by Leaning with Links -->
                {% if item.source_links %}
                <div class="mt-3 pt-3 border-t border-gray-100">
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Read the Sources</p>
                    <div class="flex flex-wrap gap-2 text-xs">
                        {% if item.source_links.left %}
                        {% for link in item.source_links.left %}
                        <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" 
                           class="inline-block bg-blue-50 text-blue-700 px-2 py-1 rounded hover:bg-blue-100 transition-colors"
                           title="{{ link.title }}">
                            {{ link.name }} â†—
                        </a>
                        {% endfor %}
                        {% endif %}

                        {% if item.source_links.center %}
                        {% for link in item.source_links.center %}
                        <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" 
                           class="inline-block bg-purple-50 text-purple-700 px-2 py-1 rounded hover:bg-purple-100 transition-colors"
                           title="{{ link.title }}">
                            {{ link.name }} â†—
                        </a>
                        {% endfor %}
                        {% endif %}

                        {% if item.source_links.right %}
                        {% for link in item.source_links.right %}
                        <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" 
                           class="inline-block bg-red-50 text-red-700 px-2 py-1 rounded hover:bg-red-100 transition-colors"
                           title="{{ link.title }}">
                            {{ link.name }} â†—
                        </a>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Summary Bullets (brief topics only) -->
            {% if item.summary %}
            <ul class="list-disc list-inside space-y-2 mb-4 text-gray-700">
                {% for bullet in item.summary %}
                <li>{{ bullet }}</li>
                {% endfor %}
            </ul>
            {% endif %}

            <!-- Perspectives Section -->
            {% if item.is_lazy_load %}
            <!-- Lazy-load button for non-brief topics -->
            <div class="mt-4">
                <button class="btn-load-perspectives w-full md:w-auto inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors"
                        data-topic-id="{{ item.topic.id }}"
                        onclick="loadPerspectives(this)">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <span class="btn-text">View Perspectives & Analysis</span>
                    <span class="btn-loading hidden">Loading...</span>
                </button>

                <div id="perspectives-{{ item.topic.id }}" class="perspectives-container hidden mt-4">
                    <!-- Populated via AJAX -->
                </div>
            </div>
            {% else %}
            <!-- Pre-loaded perspectives for brief topics -->
            {% if item.personal_impact %}
            <div class="bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-4 mb-4">
                <p class="text-xs font-bold text-blue-700 uppercase tracking-wide mb-1">ðŸ’¡ Why This Matters</p>
                <p class="text-blue-900">{{ item.personal_impact }}</p>
            </div>
            {% endif %}

            {% if item.perspectives %}
            <div class="perspectives-section mb-4">
                <h4 class="text-lg font-bold text-gray-900 mb-3">How It's Being Framed:</h4>

                <div class="space-y-3">
                    {% if item.perspectives.left %}
                    <div class="border-l-4 border-blue-500 pl-4">
                        <div class="flex items-center mb-1">
                            <span class="text-2xl mr-2">ðŸ”µ</span>
                            <strong class="text-sm text-gray-700">Left-leaning outlets emphasize:</strong>
                        </div>
                        <p class="text-gray-800 text-sm">{{ item.perspectives.left }}</p>
                    </div>
                    {% endif %}

                    {% if item.perspectives.center %}
                    <div class="border-l-4 border-purple-500 pl-4">
                        <div class="flex items-center mb-1">
                            <span class="text-2xl mr-2">âšª</span>
                            <strong class="text-sm text-gray-700">Center outlets focus on:</strong>
                        </div>
                        <p class="text-gray-800 text-sm">{{ item.perspectives.center }}</p>
                    </div>
                    {% endif %}

                    {% if item.perspectives.right %}
                    <div class="border-l-4 border-red-500 pl-4">
                        <div class="flex items-center mb-1">
                            <span class="text-2xl mr-2">ðŸ”´</span>
                            <strong class="text-sm text-gray-700">Right-leaning outlets highlight:</strong>
                        </div>
                        <p class="text-gray-800 text-sm">{{ item.perspectives.right }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if item.so_what %}
            <div class="bg-amber-50 border-l-4 border-amber-500 rounded-r-lg p-4">
                <strong class="text-sm text-amber-700 font-bold">So What?</strong>
                <p class="text-amber-900 mt-1">{{ item.so_what }}</p>
            </div>
            {% endif %}
            {% endif %}

        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <p class="text-xl text-gray-600">No topics available for today.</p>
        <p class="text-gray-500 mt-2">Check back later for the latest news analysis.</p>
    </div>
    {% endif %}
</div>

<script>
// Filter functionality
let currentFilter = 'all';

function filterTopics(leaning) {
    currentFilter = leaning;
    const cards = document.querySelectorAll('.topic-card');
    const buttons = document.querySelectorAll('.filter-btn');

    // Update button styles
    buttons.forEach(btn => {
        if (btn.dataset.filter === leaning) {
            btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            btn.classList.add('bg-blue-600', 'text-white');
        } else {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
        }
    });

    // Filter cards
    cards.forEach(card => {
        if (leaning === 'all' || card.dataset.leaning === leaning) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// HTML escape function to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Lazy-load perspectives
async function loadPerspectives(button) {
    const topicId = button.dataset.topicId;
    const container = document.getElementById(`perspectives-${topicId}`);
    const btnText = button.querySelector('.btn-text');
    const btnLoading = button.querySelector('.btn-loading');

    // Show loading state
    btnText.classList.add('hidden');
    btnLoading.classList.remove('hidden');
    button.disabled = true;

    try {
        const response = await fetch(`/api/news/perspectives/${topicId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to load perspectives');
        }

        const data = await response.json();

        // Render perspectives
        let html = '';

        if (data.personal_impact) {
            html += `
                <div class="bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-4 mb-4">
                    <p class="text-xs font-bold text-blue-700 uppercase tracking-wide mb-1">ðŸ’¡ Why This Matters</p>
                    <p class="text-blue-900">${escapeHtml(data.personal_impact)}</p>
                </div>
            `;
        }

        if (data.perspectives) {
            html += `<div class="perspectives-section mb-4">
                <h4 class="text-lg font-bold text-gray-900 mb-3">How It's Being Framed:</h4>
                <div class="space-y-3">`;

            if (data.perspectives.left) {
                html += `
                    <div class="border-l-4 border-blue-500 pl-4">
                        <div class="flex items-center mb-1">
                            <span class="text-2xl mr-2">ðŸ”µ</span>
                            <strong class="text-sm text-gray-700">Left-leaning outlets emphasize:</strong>
                        </div>
                        <p class="text-gray-800 text-sm">${escapeHtml(data.perspectives.left)}</p>
                    </div>
                `;
            }

            if (data.perspectives.center) {
                html += `
                    <div class="border-l-4 border-purple-500 pl-4">
                        <div class="flex items-center mb-1">
                            <span class="text-2xl mr-2">âšª</span>
                            <strong class="text-sm text-gray-700">Center outlets focus on:</strong>
                        </div>
                        <p class="text-gray-800 text-sm">${escapeHtml(data.perspectives.center)}</p>
                    </div>
                `;
            }

            if (data.perspectives.right) {
                html += `
                    <div class="border-l-4 border-red-500 pl-4">
                        <div class="flex items-center mb-1">
                            <span class="text-2xl mr-2">ðŸ”´</span>
                            <strong class="text-sm text-gray-700">Right-leaning outlets highlight:</strong>
                        </div>
                        <p class="text-gray-800 text-sm">${escapeHtml(data.perspectives.right)}</p>
                    </div>
                `;
            }

            html += '</div></div>';
        }

        if (data.so_what) {
            html += `
                <div class="bg-amber-50 border-l-4 border-amber-500 rounded-r-lg p-4">
                    <strong class="text-sm text-amber-700 font-bold">So What?</strong>
                    <p class="text-amber-900 mt-1">${escapeHtml(data.so_what)}</p>
                </div>
            `;
        }

        container.innerHTML = html;
        container.classList.remove('hidden');
        button.remove();

    } catch (error) {
        console.error('Error loading perspectives:', error);
        btnText.textContent = 'Failed to load. Try again?';
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
        button.disabled = false;

        // Show error message
        container.innerHTML = `
            <div class="bg-red-50 border-l-4 border-red-500 rounded-r-lg p-4 text-red-800">
                Failed to load analysis. Please try again.
            </div>
        `;
        container.classList.remove('hidden');
    }
}
</script>

<style>
.topic-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.topic-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.filter-btn {
    cursor: pointer;
}

.btn-load-perspectives:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
{% endblock %}
