{% extends "layout.html" %}
{% from "components/breadcrumb.html" import breadcrumb %}
{% from "components/choices_js.html" import choices_js_assets, init_choices_dropdown %}

{% block content %}
{{ choices_js_assets() }}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {{ breadcrumb([
            {'label': 'My Briefings', 'url': url_for('briefing.list_briefings')},
            {'label': 'Create Briefing', 'url': '#'}
        ]) }}
        
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Create Briefing</h1>
            <p class="mt-2 text-gray-600">Set up a personalised brief with your preferred sources and schedule</p>
        </div>

        <!-- Workflow guidance -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-4 sm:p-5 mb-6 shadow-sm">
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="text-sm font-semibold text-blue-900 mb-1">Two-Step Setup Process</h3>
                    <p class="text-sm text-blue-800 mb-2">
                        <strong>Step 1:</strong> Create your briefing below with basic settings (name, schedule, template).
                    </p>
                    <p class="text-sm text-blue-800">
                        <strong>Step 2:</strong> On the next screen, you'll add content sources (RSS feeds, curated sources, or documents) and customize AI settings.
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg">
            <form method="POST" class="p-6 space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <!-- Name -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Briefing Name *</label>
                    <input type="text" name="name" id="name" required
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           placeholder="e.g., Daily Tech Brief">
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea name="description" id="description" rows="3"
                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                              placeholder="Optional description of what this briefing covers"></textarea>
                </div>

                <!-- Owner Type -->
                <div>
                    <label for="owner_type" class="block text-sm font-medium text-gray-700">Type</label>
                    <select name="owner_type" id="owner_type"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="user" {% if not current_user.company_profile %}selected{% endif %}>Personal</option>
                        {% if current_user.company_profile %}
                        <option value="org">Organisation ({{ current_user.company_profile.company_name }})</option>
                        {% endif %}
                    </select>
                </div>

                <!-- Template (Optional) -->
                {% if templates %}
                <div>
                    <label for="template_id" class="block text-sm font-medium text-gray-700">Template (Optional)</label>
                    <select name="template_id" id="template_id"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">None - Create Custom</option>
                        {% for template in templates %}
                        <option value="{{ template.id }}">{{ template.name }}</option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Start with a predefined template or create your own</p>
                </div>
                {% endif %}

                <!-- Cadence -->
                <div>
                    <label for="cadence" class="block text-sm font-medium text-gray-700">Frequency</label>
                    <select name="cadence" id="cadence"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                    </select>
                </div>

                <!-- Timezone -->
                <div>
                    <label for="timezone" class="block text-sm font-medium text-gray-700">Timezone</label>
                    <select name="timezone" id="timezone"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        {% for tz in all_timezones %}
                        <option value="{{ tz }}" {% if tz == 'UTC' %}selected{% endif %}>{{ tz }}</option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Select your timezone for accurate scheduling</p>
                </div>

                <!-- Send Time -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="preferred_send_hour" class="block text-sm font-medium text-gray-700">Send Hour</label>
                        <select name="preferred_send_hour" id="preferred_send_hour"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            {% for hour in range(0, 24) %}
                            <option value="{{ hour }}" {% if hour == 18 %}selected{% endif %}>
                                {{ "%02d:00"|format(hour) }} {% if hour < 12 %}AM{% else %}PM{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="preferred_send_minute" class="block text-sm font-medium text-gray-700">Send Minute</label>
                        <select name="preferred_send_minute" id="preferred_send_minute"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            {% for minute in range(0, 60, 5) %}
                            <option value="{{ minute }}" {% if minute == 0 %}selected{% endif %}>{{ "%02d"|format(minute) }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <p class="text-sm text-gray-500">Default: 6:00 PM - a popular time for end-of-day reading. Adjust to match your schedule.</p>

                <!-- Mode -->
                <div>
                    <label for="mode" class="block text-sm font-medium text-gray-700">Approval Mode</label>
                    <select name="mode" id="mode"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="auto_send" selected>Auto-send (send immediately when generated)</option>
                        <option value="approval_required">Require approval (review before sending)</option>
                    </select>
                </div>

                <!-- Premium Styling Section -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Email Styling</h3>
                    <p class="text-sm text-gray-500 mb-4">Customise how your briefings look. Great defaults are set for you.</p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Accent Colour -->
                        <div>
                            <label for="accent_color" class="block text-sm font-medium text-gray-700">Brand Colour</label>
                            <div class="mt-1 flex items-center gap-3">
                                <input type="color" name="accent_color" id="accent_color" value="#1e40af"
                                       class="h-10 w-16 rounded border-gray-300 cursor-pointer">
                                <input type="text" id="accent_color_text" value="#1e40af" maxlength="7"
                                       class="block w-24 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <p class="mt-1 text-sm text-gray-500">Used for headers and highlights</p>
                        </div>
                        
                        <!-- Tone -->
                        <div>
                            <label for="tone" class="block text-sm font-medium text-gray-700">Writing Tone</label>
                            <select name="tone" id="tone"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="calm_neutral" selected>Calm & Balanced (recommended)</option>
                                <option value="formal">Formal & Professional</option>
                                <option value="conversational">Friendly & Conversational</option>
                            </select>
                            <p class="mt-1 text-sm text-gray-500">Sets the AI writing style</p>
                        </div>
                    </div>
                    
                    <!-- Max Items -->
                    <div class="mt-4">
                        <label for="max_items" class="block text-sm font-medium text-gray-700">Stories per Brief</label>
                        <select name="max_items" id="max_items"
                                class="mt-1 block w-full sm:w-48 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="5">5 stories (quick read)</option>
                            <option value="8" selected>8 stories (balanced)</option>
                            <option value="10">10 stories (comprehensive)</option>
                            <option value="15">15 stories (in-depth)</option>
                        </select>
                    </div>
                </div>

                <!-- Visibility -->
                <div>
                    <label for="visibility" class="block text-sm font-medium text-gray-700">Visibility</label>
                    <select name="visibility" id="visibility"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="private" selected>Private (only you)</option>
                        {% if current_user.company_profile %}
                        <option value="org_only">Organisation only</option>
                        {% endif %}
                        <option value="public">Public (anyone can view)</option>
                    </select>
                </div>

                <!-- Branding (for org briefings) -->
                {% if current_user.company_profile %}
                <div id="org-branding-section" style="display: none;" class="pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Email Branding</h3>
                    <p class="text-sm text-gray-500 mb-4">Configure custom email sender for organisation briefings.</p>
                    
                    <!-- Sending Domain -->
                    <div class="mb-4">
                        <label for="sending_domain_id" class="block text-sm font-medium text-gray-700">Sending Domain</label>
                        <select name="sending_domain_id" id="sending_domain_id"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Use default (societyspeaks.io)</option>
                            {% for domain in available_domains %}
                            <option value="{{ domain.id }}">
                                {{ domain.domain }} 
                                {% if domain.status == 'verified' %}(Verified){% elif domain.status == 'pending_verification' %}(Pending){% else %}(Failed){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">
                            <a href="{{ url_for('briefing.list_domains') }}" class="text-blue-600 hover:text-blue-800">Manage domains</a>
                        </p>
                    </div>
                    
                    <!-- From Name -->
                    <div class="mb-4">
                        <label for="from_name" class="block text-sm font-medium text-gray-700">Sender Name</label>
                        <input type="text" name="from_name" id="from_name" 
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               placeholder="e.g., Acme Corp Briefings">
                        <p class="mt-1 text-sm text-gray-500">Name shown as email sender (defaults to briefing name)</p>
                    </div>
                    
                    <!-- From Email -->
                    <div class="mb-4">
                        <label for="from_email" class="block text-sm font-medium text-gray-700">
                            Sender Email
                            <span id="email-required-indicator" class="text-red-500" style="display: none;">*</span>
                        </label>
                        <input type="email" name="from_email" id="from_email" 
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               placeholder="briefings@yourdomain.com">
                        <p class="mt-1 text-sm text-gray-500" id="email-help-text">
                            Must match selected domain. Leave empty to use default.
                        </p>
                        <p class="mt-1 text-sm text-red-600 hidden" id="email-error-text"></p>
                    </div>
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-3 pt-4 border-t border-gray-200">
                    <a href="{{ url_for('briefing.list_briefings') }}"
                       class="w-full sm:w-auto text-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </a>
                    <button type="submit"
                            class="w-full sm:w-auto px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Create Briefing
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-detect user's timezone before initializing Choices.js
    try {
        const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const timezoneSelect = document.getElementById('timezone');
        if (timezoneSelect && userTimezone) {
            for (let option of timezoneSelect.options) {
                if (option.value === userTimezone) {
                    option.selected = true;
                    break;
                }
            }
        }
    } catch (e) {
        console.log('Timezone detection failed, using UTC');
    }

    // Initialize Choices.js for timezone dropdown (DRY - using reusable macro)
    {{ init_choices_dropdown('timezone', 'Search timezones...', 'Select a timezone...') }}

    // Sync color picker with text input
    const colorPicker = document.getElementById('accent_color');
    const colorText = document.getElementById('accent_color_text');
    if (colorPicker && colorText) {
        colorPicker.addEventListener('input', function() {
            colorText.value = this.value;
        });
        colorText.addEventListener('input', function() {
            if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
                colorPicker.value = this.value;
            }
        });
    }
    
    // Show/hide org branding section based on owner_type
    const ownerTypeSelect = document.getElementById('owner_type');
    const brandingSection = document.getElementById('org-branding-section');
    const domainSelect = document.getElementById('sending_domain_id');
    const emailInput = document.getElementById('from_email');
    const emailRequiredIndicator = document.getElementById('email-required-indicator');
    const emailHelpText = document.getElementById('email-help-text');
    const emailErrorText = document.getElementById('email-error-text');
    
    // Toggle branding section
    if (ownerTypeSelect && brandingSection) {
        function toggleBranding() {
            if (ownerTypeSelect.value === 'org') {
                brandingSection.style.display = 'block';
            } else {
                brandingSection.style.display = 'none';
            }
        }
        
        ownerTypeSelect.addEventListener('change', toggleBranding);
        toggleBranding(); // Initial state
    }
    
    // Auto-suggest email when domain selected
    if (domainSelect && emailInput) {
        domainSelect.addEventListener('change', function() {
            const selectedOption = domainSelect.options[domainSelect.selectedIndex];
            
            if (selectedOption.value) {
                // Extract domain from option text (e.g., "example.com (Verified)" or "example.com (Pending)")
                const domainMatch = selectedOption.text.match(/^([^\s]+)/);
                if (domainMatch && !emailInput.value) {
                    const domain = domainMatch[1];
                    emailInput.value = `briefings@${domain}`;
                    emailInput.focus();
                    // Move cursor to before @ for easy editing
                    emailInput.setSelectionRange(0, emailInput.value.indexOf('@'));
                }
                
                // Show required indicator
                if (emailRequiredIndicator) {
                    emailRequiredIndicator.style.display = 'inline';
                }
                if (emailHelpText) {
                    emailHelpText.textContent = `Required. Must match selected domain: ${domainMatch[1]}`;
                    emailHelpText.classList.remove('text-gray-500');
                    emailHelpText.classList.add('text-blue-600');
                }
                
                // Validate email matches domain
                validateEmailDomain();
            } else {
                // No domain selected
                if (emailRequiredIndicator) {
                    emailRequiredIndicator.style.display = 'none';
                }
                if (emailHelpText) {
                    emailHelpText.textContent = 'Must match selected domain. Leave empty to use default.';
                    emailHelpText.classList.remove('text-blue-600');
                    emailHelpText.classList.add('text-gray-500');
                }
                if (emailErrorText) {
                    emailErrorText.classList.add('hidden');
                }
            }
        });
    }
    
    // Validate email matches domain on input
    if (emailInput && domainSelect) {
        emailInput.addEventListener('input', validateEmailDomain);
        emailInput.addEventListener('blur', validateEmailDomain);
    }
    
    function validateEmailDomain() {
        if (!domainSelect || !emailInput || !emailErrorText) return;
        
        const selectedOption = domainSelect.options[domainSelect.selectedIndex];
        if (!selectedOption || !selectedOption.value) {
            emailErrorText.classList.add('hidden');
            return;
        }
        
        const domainMatch = selectedOption.text.match(/^([^\s]+)/);
        if (!domainMatch) return;
        
        const expectedDomain = domainMatch[1];
        const emailValue = emailInput.value.trim();
        
        if (!emailValue) {
            emailErrorText.textContent = 'Email is required when a domain is selected.';
            emailErrorText.classList.remove('hidden');
            emailInput.classList.add('border-red-300');
            emailInput.classList.remove('border-gray-300');
            return;
        }
        
        const emailDomain = emailValue.split('@')[1];
        if (emailDomain !== expectedDomain) {
            emailErrorText.textContent = `Email must be from domain: ${expectedDomain}`;
            emailErrorText.classList.remove('hidden');
            emailInput.classList.add('border-red-300');
            emailInput.classList.remove('border-gray-300');
        } else {
            emailErrorText.classList.add('hidden');
            emailInput.classList.remove('border-red-300');
            emailInput.classList.add('border-gray-300');
        }
    }
    
    // Form validation before submit
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (domainSelect && domainSelect.value && emailInput && !emailInput.value.trim()) {
                e.preventDefault();
                emailErrorText.textContent = 'Email is required when a domain is selected.';
                emailErrorText.classList.remove('hidden');
                emailInput.focus();
                emailInput.classList.add('border-red-300');
                return false;
            }
            
            if (domainSelect && domainSelect.value && emailInput && emailInput.value.trim()) {
                const selectedOption = domainSelect.options[domainSelect.selectedIndex];
                const domainMatch = selectedOption.text.match(/^([^\s]+)/);
                if (domainMatch) {
                    const expectedDomain = domainMatch[1];
                    const emailDomain = emailInput.value.trim().split('@')[1];
                    if (emailDomain !== expectedDomain) {
                        e.preventDefault();
                        emailErrorText.textContent = `Email must be from domain: ${expectedDomain}`;
                        emailErrorText.classList.remove('hidden');
                        emailInput.focus();
                        emailInput.classList.add('border-red-300');
                        return false;
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
