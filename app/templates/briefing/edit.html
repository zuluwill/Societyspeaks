{% extends "layout.html" %}
{% from "components/breadcrumb.html" import breadcrumb %}
{% from "components/choices_js.html" import choices_js_assets, init_choices_dropdown %}

{% block content %}
{{ choices_js_assets() }}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {{ breadcrumb([
            {'label': 'My Briefings', 'url': url_for('briefing.list_briefings')},
            {'label': briefing.name, 'url': url_for('briefing.detail', briefing_id=briefing.id)},
            {'label': 'Edit', 'url': '#'}
        ]) }}
        
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Edit Briefing</h1>
            <p class="mt-2 text-gray-600">Update your briefing configuration</p>
        </div>

        <div class="bg-white shadow rounded-lg">
            <form method="POST" class="p-6 space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <!-- Name -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Briefing Name *</label>
                    <input type="text" name="name" id="name" required value="{{ briefing.name }}"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea name="description" id="description" rows="3"
                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">{{ briefing.description or '' }}</textarea>
                </div>

                <!-- Cadence -->
                <div>
                    <label for="cadence" class="block text-sm font-medium text-gray-700">Frequency</label>
                    <select name="cadence" id="cadence"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="daily" {% if briefing.cadence == 'daily' %}selected{% endif %}>Daily</option>
                        <option value="weekly" {% if briefing.cadence == 'weekly' %}selected{% endif %}>Weekly</option>
                    </select>
                </div>

                <!-- Timezone -->
                <div>
                    <label for="timezone" class="block text-sm font-medium text-gray-700">Timezone</label>
                    <select name="timezone" id="timezone"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        {% for tz in all_timezones %}
                        <option value="{{ tz }}" {% if briefing.timezone == tz %}selected{% endif %}>{{ tz }}</option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Select your timezone for accurate scheduling</p>
                </div>

                <!-- Send Time -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="preferred_send_hour" class="block text-sm font-medium text-gray-700">Send Hour</label>
                        <select name="preferred_send_hour" id="preferred_send_hour"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            {% for hour in range(0, 24) %}
                            <option value="{{ hour }}" {% if briefing.preferred_send_hour == hour %}selected{% endif %}>
                                {{ "%02d:00"|format(hour) }} {% if hour < 12 %}AM{% else %}PM{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="preferred_send_minute" class="block text-sm font-medium text-gray-700">Send Minute</label>
                        <select name="preferred_send_minute" id="preferred_send_minute"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            {% for minute in range(0, 60, 5) %}
                            <option value="{{ minute }}" {% if (briefing.preferred_send_minute|default(0)) == minute %}selected{% endif %}>{{ "%02d"|format(minute) }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <p class="text-sm text-gray-500">Choose the time (hour and minute) when briefs should be sent in your selected timezone</p>

                <!-- Mode -->
                <div>
                    <label for="mode" class="block text-sm font-medium text-gray-700">Approval Mode</label>
                    <select name="mode" id="mode"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="auto_send" {% if briefing.mode == 'auto_send' %}selected{% endif %}>Auto-send</option>
                        <option value="approval_required" {% if briefing.mode == 'approval_required' %}selected{% endif %}>Require approval</option>
                    </select>
                </div>

                <!-- Visibility -->
                <div>
                    <label for="visibility" class="block text-sm font-medium text-gray-700">Visibility</label>
                    <select name="visibility" id="visibility"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="private" {% if briefing.visibility == 'private' %}selected{% endif %}>Private</option>
                        <option value="org_only" {% if briefing.visibility == 'org_only' %}selected{% endif %}>Organization only</option>
                        <option value="public" {% if briefing.visibility == 'public' %}selected{% endif %}>Public</option>
                    </select>
                </div>

                <!-- Status -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                    <select name="status" id="status"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="active" {% if briefing.status == 'active' %}selected{% endif %}>Active</option>
                        <option value="paused" {% if briefing.status == 'paused' %}selected{% endif %}>Paused</option>
                    </select>
                </div>

                <!-- AI Settings Section -->
                <div id="ai-settings" class="pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">AI Settings</h3>
                    <p class="text-sm text-gray-500 mb-4">Customize how your brief content is generated.</p>
                    
                    <div class="space-y-4">
                        <!-- Tone -->
                        <div>
                            <label for="tone" class="block text-sm font-medium text-gray-700">Writing Tone</label>
                            <select name="tone" id="tone"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="calm_neutral" {% if (briefing.tone or 'calm_neutral') == 'calm_neutral' %}selected{% endif %}>Calm & Neutral</option>
                                <option value="formal" {% if briefing.tone == 'formal' %}selected{% endif %}>Formal & Professional</option>
                                <option value="conversational" {% if briefing.tone == 'conversational' %}selected{% endif %}>Conversational & Friendly</option>
                            </select>
                            <p class="mt-1 text-sm text-gray-500">The writing style for your generated briefs</p>
                        </div>
                        
                        <!-- Max Items -->
                        <div>
                            <label for="max_items" class="block text-sm font-medium text-gray-700">Maximum Stories</label>
                            <select name="max_items" id="max_items"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                {% for num in [5, 7, 10, 15, 20] %}
                                <option value="{{ num }}" {% if (briefing.max_items|default(10)) == num %}selected{% endif %}>{{ num }} stories</option>
                                {% endfor %}
                            </select>
                            <p class="mt-1 text-sm text-gray-500">Maximum number of stories to include per brief</p>
                        </div>
                        
                        <!-- Custom Prompt -->
                        <div>
                            <label for="custom_prompt" class="block text-sm font-medium text-gray-700">Custom Instructions (Optional)</label>
                            <textarea name="custom_prompt" id="custom_prompt" rows="4"
                                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                      placeholder="Add custom instructions for the AI, e.g., 'Focus on industry-specific terminology' or 'Include actionable takeaways'">{{ briefing.custom_prompt or '' }}</textarea>
                            <p class="mt-1 text-sm text-gray-500">Additional guidance for how the AI should write your briefs. Leave empty for default behavior.</p>
                        </div>
                    </div>
                </div>

                <!-- Visual Branding Section -->
                <div id="branding" class="pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Visual Branding</h3>
                    <p class="text-sm text-gray-500 mb-4">Customize the look and feel of your briefs.</p>
                    
                    <div class="space-y-4">
                        <!-- Logo URL -->
                        <div>
                            <label for="logo_url" class="block text-sm font-medium text-gray-700">Logo URL</label>
                            <input type="url" name="logo_url" id="logo_url"
                                   value="{{ briefing.logo_url or '' }}"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                   placeholder="https://example.com/logo.png">
                            <p class="mt-1 text-sm text-gray-500">URL to your logo image (PNG, JPG, SVG)</p>
                            {% if briefing.logo_url %}
                            <div class="mt-2">
                                <img src="{{ briefing.logo_url }}" alt="Current logo" class="h-12 w-auto object-contain border rounded p-1">
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Accent Color -->
                        <div>
                            <label for="accent_color" class="block text-sm font-medium text-gray-700">Accent Color</label>
                            <div class="mt-1 flex items-center space-x-3">
                                <input type="color" name="accent_color" id="accent_color"
                                       value="{{ briefing.accent_color or '#3B82F6' }}"
                                       class="h-10 w-14 border-gray-300 rounded cursor-pointer">
                                <input type="text" id="accent_color_hex" 
                                       value="{{ briefing.accent_color or '#3B82F6' }}"
                                       class="flex-1 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                       placeholder="#3B82F6" pattern="^#[0-9A-Fa-f]{6}$">
                            </div>
                            <p class="mt-1 text-sm text-gray-500">Color used for headers, links, and accents</p>
                        </div>
                        
                        <!-- Header Text -->
                        <div>
                            <label for="header_text" class="block text-sm font-medium text-gray-700">Custom Header Text</label>
                            <input type="text" name="header_text" id="header_text"
                                   value="{{ briefing.header_text or '' }}"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                   placeholder="e.g., Your Daily Industry Update">
                            <p class="mt-1 text-sm text-gray-500">Custom text shown at the top of each brief (optional)</p>
                        </div>
                    </div>
                </div>

                <!-- Email Branding (for org briefings) -->
                {% if briefing.owner_type == 'org' %}
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Email Branding</h3>
                    
                    <!-- Sending Domain -->
                    <div class="mb-4">
                        <label for="sending_domain_id" class="block text-sm font-medium text-gray-700">Sending Domain</label>
                        <select name="sending_domain_id" id="sending_domain_id"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Use default (societyspeaks.io)</option>
                            {% for domain in available_domains %}
                            <option value="{{ domain.id }}" 
                                    {% if briefing.sending_domain_id == domain.id %}selected{% endif %}>
                                {{ domain.domain }} 
                                {% if domain.status == 'verified' %}(Verified){% elif domain.status == 'pending_verification' %}(Pending){% else %}(Failed){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">
                            <a href="{{ url_for('briefing.list_domains') }}" class="text-blue-600 hover:text-blue-800">Manage domains</a>
                        </p>
                    </div>
                    
                    <!-- From Name -->
                    <div class="mb-4">
                        <label for="from_name" class="block text-sm font-medium text-gray-700">Sender Name</label>
                        <input type="text" name="from_name" id="from_name" 
                               value="{{ briefing.from_name or '' }}"
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               placeholder="e.g., Acme Corp Briefings">
                        <p class="mt-1 text-sm text-gray-500">Name shown as email sender (defaults to briefing name)</p>
                    </div>
                    
                    <!-- From Email -->
                    <div class="mb-4">
                        <label for="from_email" class="block text-sm font-medium text-gray-700">
                            Sender Email
                            <span id="email-required-indicator" class="text-red-500" style="display: none;">*</span>
                        </label>
                        <input type="email" name="from_email" id="from_email" 
                               value="{{ briefing.from_email or '' }}"
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               placeholder="briefings@yourdomain.com">
                        <p class="mt-1 text-sm text-gray-500" id="email-help-text">
                            Must match selected domain. Leave empty to use default.
                        </p>
                        <p class="mt-1 text-sm text-red-600 hidden" id="email-error-text"></p>
                    </div>
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-3 pt-4 border-t border-gray-200">
                    <a href="{{ url_for('briefing.detail', briefing_id=briefing.id) }}"
                       class="w-full sm:w-auto text-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </a>
                    <button type="submit"
                            class="w-full sm:w-auto px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Choices.js for timezone dropdown (DRY - using reusable macro)
    {{ init_choices_dropdown('timezone', 'Search timezones...', 'Select a timezone...') }}
    
    // Auto-suggest email when domain selected and validate
    const domainSelect = document.getElementById('sending_domain_id');
    const emailInput = document.getElementById('from_email');
    const emailRequiredIndicator = document.getElementById('email-required-indicator');
    const emailHelpText = document.getElementById('email-help-text');
    const emailErrorText = document.getElementById('email-error-text');
    
    // Auto-suggest email when domain selected
    if (domainSelect && emailInput) {
        // Check initial state
        const initialDomain = domainSelect.value;
        if (initialDomain && !emailInput.value) {
            const selectedOption = domainSelect.options[domainSelect.selectedIndex];
            const domainMatch = selectedOption.text.match(/^([^\s]+)/);
            if (domainMatch) {
                emailInput.value = `briefings@${domainMatch[1]}`;
            }
        }
        
        domainSelect.addEventListener('change', function() {
            const selectedOption = domainSelect.options[domainSelect.selectedIndex];
            
            if (selectedOption.value) {
                // Extract domain from option text
                const domainMatch = selectedOption.text.match(/^([^\s]+)/);
                if (domainMatch && !emailInput.value) {
                    const domain = domainMatch[1];
                    emailInput.value = `briefings@${domain}`;
                    emailInput.focus();
                    emailInput.setSelectionRange(0, emailInput.value.indexOf('@'));
                }
                
                // Show required indicator
                if (emailRequiredIndicator) {
                    emailRequiredIndicator.style.display = 'inline';
                }
                if (emailHelpText) {
                    emailHelpText.textContent = `Required. Must match selected domain: ${domainMatch[1]}`;
                    emailHelpText.classList.remove('text-gray-500');
                    emailHelpText.classList.add('text-blue-600');
                }
                
                validateEmailDomain();
            } else {
                // No domain selected
                if (emailRequiredIndicator) {
                    emailRequiredIndicator.style.display = 'none';
                }
                if (emailHelpText) {
                    emailHelpText.textContent = 'Must match selected domain. Leave empty to use default.';
                    emailHelpText.classList.remove('text-blue-600');
                    emailHelpText.classList.add('text-gray-500');
                }
                if (emailErrorText) {
                    emailErrorText.classList.add('hidden');
                }
            }
        });
    }
    
    // Validate email matches domain on input
    if (emailInput && domainSelect) {
        emailInput.addEventListener('input', validateEmailDomain);
        emailInput.addEventListener('blur', validateEmailDomain);
        
        // Initial validation
        if (domainSelect.value) {
            validateEmailDomain();
        }
    }
    
    function validateEmailDomain() {
        if (!domainSelect || !emailInput || !emailErrorText) return;
        
        const selectedOption = domainSelect.options[domainSelect.selectedIndex];
        if (!selectedOption || !selectedOption.value) {
            emailErrorText.classList.add('hidden');
            return;
        }
        
        const domainMatch = selectedOption.text.match(/^([^\s]+)/);
        if (!domainMatch) return;
        
        const expectedDomain = domainMatch[1];
        const emailValue = emailInput.value.trim();
        
        if (!emailValue) {
            emailErrorText.textContent = 'Email is required when a domain is selected.';
            emailErrorText.classList.remove('hidden');
            emailInput.classList.add('border-red-300');
            emailInput.classList.remove('border-gray-300');
            return;
        }
        
        const emailDomain = emailValue.split('@')[1];
        if (emailDomain !== expectedDomain) {
            emailErrorText.textContent = `Email must be from domain: ${expectedDomain}`;
            emailErrorText.classList.remove('hidden');
            emailInput.classList.add('border-red-300');
            emailInput.classList.remove('border-gray-300');
        } else {
            emailErrorText.classList.add('hidden');
            emailInput.classList.remove('border-red-300');
            emailInput.classList.add('border-gray-300');
        }
    }
    
    // Form validation before submit
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (domainSelect && domainSelect.value && emailInput && !emailInput.value.trim()) {
                e.preventDefault();
                emailErrorText.textContent = 'Email is required when a domain is selected.';
                emailErrorText.classList.remove('hidden');
                emailInput.focus();
                emailInput.classList.add('border-red-300');
                return false;
            }
            
            if (domainSelect && domainSelect.value && emailInput && emailInput.value.trim()) {
                const selectedOption = domainSelect.options[domainSelect.selectedIndex];
                const domainMatch = selectedOption.text.match(/^([^\s]+)/);
                if (domainMatch) {
                    const expectedDomain = domainMatch[1];
                    const emailDomain = emailInput.value.trim().split('@')[1];
                    if (emailDomain !== expectedDomain) {
                        e.preventDefault();
                        emailErrorText.textContent = `Email must be from domain: ${expectedDomain}`;
                        emailErrorText.classList.remove('hidden');
                        emailInput.focus();
                        emailInput.classList.add('border-red-300');
                        return false;
                    }
                }
            }
        });
    }
    
    // Color picker sync with hex input
    const colorPicker = document.getElementById('accent_color');
    const colorHexInput = document.getElementById('accent_color_hex');
    
    if (colorPicker && colorHexInput) {
        colorPicker.addEventListener('input', function() {
            colorHexInput.value = this.value.toUpperCase();
        });
        
        colorHexInput.addEventListener('input', function() {
            let value = this.value.trim();
            if (!value.startsWith('#')) {
                value = '#' + value;
            }
            if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                colorPicker.value = value;
            }
        });
        
        colorHexInput.addEventListener('blur', function() {
            let value = this.value.trim();
            if (!value.startsWith('#')) {
                value = '#' + value;
            }
            if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                this.value = value.toUpperCase();
                colorPicker.value = value;
            } else {
                this.value = colorPicker.value.toUpperCase();
            }
        });
    }
});
</script>
{% endblock %}
