{# Native Statement System View (Phase 1) #}
{# Inspired by pol.is progressive disclosure pattern #}

<div class="bg-white rounded-lg shadow-lg p-6">
    <!-- Statement Submission Section -->
    {% if current_user.is_authenticated %}
    <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-100">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Add Your Perspective</h3>
        <form action="{{ url_for('statements.create_statement', discussion_id=discussion.id) }}" method="POST" class="space-y-4">
            {{ form.hidden_tag() if form else '' }}
            <div>
                <label for="statement-content" class="block text-sm font-medium text-gray-700 mb-2">
                    Your Statement (10-500 characters)
                </label>
                <textarea 
                    name="content" 
                    id="statement-content" 
                    rows="3" 
                    maxlength="500"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Share your perspective on this topic..."></textarea>
                <div class="mt-1 text-sm text-gray-500 text-right">
                    <span id="char-count">0</span> / 500
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <div>
                    <label class="inline-flex items-center">
                        <input type="radio" name="statement_type" value="claim" checked class="mr-2">
                        <span class="text-sm text-gray-700">Claim</span>
                    </label>
                    <label class="inline-flex items-center ml-4">
                        <input type="radio" name="statement_type" value="question" class="mr-2">
                        <span class="text-sm text-gray-700">Question</span>
                    </label>
                </div>
                <button 
                    type="submit" 
                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    Post Statement
                </button>
            </div>
        </form>
    </div>
    {% else %}
    <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
        <p class="text-gray-700 text-center">
            <a href="{{ url_for('auth.login') }}" class="text-blue-600 hover:underline font-medium">Log in</a> 
            or 
            <a href="{{ url_for('auth.register') }}" class="text-blue-600 hover:underline font-medium">register</a> 
            to add your perspective
        </p>
    </div>
    {% endif %}

    <!-- Sorting Options -->
    <div class="mb-6 flex items-center justify-between flex-wrap gap-4">
        <div>
            <h3 class="text-xl font-semibold text-gray-900">
                {{ statements|length if statements else '0' }} Statement{{ 's' if statements|length != 1 else '' }}
            </h3>
        </div>
        <div class="flex items-center space-x-2">
            <label for="sort-select" class="text-sm text-gray-700 font-medium">Sort by:</label>
            <select 
                id="sort-select" 
                onchange="window.location.href='?sort=' + this.value"
                class="px-3 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                <option value="progressive" {{ 'selected' if sort == 'progressive' else '' }}>Progressive (Pol.is style)</option>
                <option value="best" {{ 'selected' if sort == 'best' else '' }}>Best</option>
                <option value="controversial" {{ 'selected' if sort == 'controversial' else '' }}>Controversial</option>
                <option value="recent" {{ 'selected' if sort == 'recent' else '' }}>Recent</option>
                <option value="most_voted" {{ 'selected' if sort == 'most_voted' else '' }}>Most Voted</option>
            </select>
        </div>
    </div>

    <!-- Statement List -->
    <div class="space-y-4">
        {% if statements %}
            {% for statement in statements %}
            <div class="p-6 bg-gray-50 rounded-lg border border-gray-200 hover:border-blue-300 transition-colors" 
                 data-statement-id="{{ statement.id }}">
                <!-- Statement Content -->
                <div class="mb-4">
                    {% if statement.statement_type == 'question' %}
                    <span class="inline-block px-2 py-1 text-xs font-semibold text-blue-600 bg-blue-100 rounded-full mb-2">
                        Question
                    </span>
                    {% endif %}
                    <p class="text-gray-900 text-lg">{{ statement.content }}</p>
                </div>

                <!-- Vote Buttons (pol.is style) -->
                <div class="flex items-center space-x-4">
                    {% if current_user.is_authenticated %}
                    <div class="flex space-x-2">
                        <button 
                            onclick="vote({{ statement.id }}, 1)" 
                            class="vote-btn px-4 py-2 bg-green-100 text-green-700 rounded-md hover:bg-green-200 transition-colors flex items-center"
                            data-vote="1">
                            <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
                            </svg>
                            Agree
                            <span class="ml-2 font-semibold">{{ statement.vote_count_agree }}</span>
                        </button>
                        <button 
                            onclick="vote({{ statement.id }}, -1)" 
                            class="vote-btn px-4 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition-colors flex items-center"
                            data-vote="-1">
                            <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M18 9.5a1.5 1.5 0 11-3 0v-6a1.5 1.5 0 013 0v6zM14 9.667v-5.43a2 2 0 00-1.105-1.79l-.05-.025A4 4 0 0011.055 2H5.64a2 2 0 00-1.962 1.608l-1.2 6A2 2 0 004.44 12H8v4a2 2 0 002 2 1 1 0 001-1v-.667a4 4 0 01.8-2.4l1.4-1.866a4 4 0 00.8-2.4z"/>
                            </svg>
                            Disagree
                            <span class="ml-2 font-semibold">{{ statement.vote_count_disagree }}</span>
                        </button>
                        <button 
                            onclick="vote({{ statement.id }}, 0)" 
                            class="vote-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors flex items-center"
                            data-vote="0">
                            <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                            </svg>
                            Unsure
                            <span class="ml-2 font-semibold">{{ statement.vote_count_unsure }}</span>
                        </button>
                    </div>
                    {% else %}
                    <div class="text-sm text-gray-500">
                        <span class="mr-4">üëç {{ statement.vote_count_agree }}</span>
                        <span class="mr-4">üëé {{ statement.vote_count_disagree }}</span>
                        <span>‚ùì {{ statement.vote_count_unsure }}</span>
                    </div>
                    {% endif %}

                    <!-- Metadata -->
                    <div class="ml-auto text-sm text-gray-500">
                        Posted {{ statement.created_at.strftime('%B %d, %Y') }}
                    </div>
                </div>

                <!-- Statement Stats -->
                {% if statement.total_votes > 5 %}
                <div class="mt-3 text-sm text-gray-600">
                    <span class="mr-4">Agreement: {{ (statement.agreement_rate * 100) | round }}%</span>
                    {% if statement.controversy_score > 0.7 %}
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">
                        Controversial
                    </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-12 text-gray-500">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                </svg>
                <p class="text-lg font-medium">No statements yet</p>
                <p class="mt-2">Be the first to share your perspective!</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Character counter for statement input
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('statement-content');
    const charCount = document.getElementById('char-count');
    
    if (textarea && charCount) {
        textarea.addEventListener('input', function() {
            charCount.textContent = this.value.length;
        });
    }
});

// Vote function (AJAX)
function vote(statementId, voteValue) {
    fetch(`/statements/${statementId}/vote`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `vote=${voteValue}&csrf_token={{ csrf_token() }}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update vote counts
            const statementDiv = document.querySelector(`[data-statement-id="${statementId}"]`);
            const buttons = statementDiv.querySelectorAll('.vote-btn');
            
            // Update button text with new counts
            buttons[0].querySelector('span').textContent = data.counts.agree;
            buttons[1].querySelector('span').textContent = data.counts.disagree;
            buttons[2].querySelector('span').textContent = data.counts.unsure;
            
            // Visual feedback
            buttons.forEach(btn => btn.classList.remove('ring-2', 'ring-blue-500'));
            const clickedBtn = statementDiv.querySelector(`.vote-btn[data-vote="${voteValue}"]`);
            if (clickedBtn) {
                clickedBtn.classList.add('ring-2', 'ring-blue-500');
            }
            
            // Show success toast
            showToast('Vote recorded!');
        } else {
            showToast('Error recording vote', 'error');
        }
    })
    .catch(error => {
        console.error('Vote error:', error);
        showToast('Error recording vote', 'error');
    });
}

// Toast notification function
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>

<style>
/* Vote button active state */
.vote-btn.ring-2 {
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
}
</style>

