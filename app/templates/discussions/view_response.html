{% extends 'layout.html' %} {% block title %}Response - {{ discussion.title }}{%
endblock %} {% block content %}
<div class="container mx-auto px-4 py-8">
  <!-- Breadcrumb -->
  <div class="mb-6">
    <nav class="text-sm">
      <a
        href="{{ url_for('discussions.list_discussions') }}"
        class="text-blue-600 hover:underline"
        >Discussions</a
      >
      <span class="mx-2">/</span>
      <a
        href="{{ url_for('discussions.view_discussion', discussion_id=response.statement.discussion.id, slug=response.statement.discussion.slug) }}"
        class="text-blue-600 hover:underline"
        >{{ response.statement.discussion.title }}</a
      >
      <span class="mx-2">/</span>
      <span class="text-gray-600">Response</span>
    </nav>
  </div>

  <!-- Thread Context -->
  {% if thread|length > 1 %}
  <div class="mb-6 bg-gray-50 border-l-4 border-blue-500 p-4">
    <h3 class="font-semibold mb-3">Thread Context:</h3>
    {% for parent in thread[:-1] %}
    <div class="mb-2 pl-4 border-l-2 border-gray-300">
      <div class="text-sm text-gray-600">
        {{ parent.user.name }} · {{ parent.position|upper if parent.position
        else 'Comment' }}
      </div>
      <div class="text-gray-800">{{ parent.content }}</div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Current Response -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex items-start justify-between mb-4">
      <div>
        <span
          class="inline-block px-3 py-1 rounded-full text-sm font-semibold mb-2 {% if response.position == 'pro' %}bg-green-100 text-green-800 {% elif response.position == 'con' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-800{% endif %}"
        >
          {{ response.position|upper if response.position else 'Comment' }}
        </span>
        <div class="text-gray-600 text-sm">
          by {{ response.user.name }} · {{ response.created_at.strftime('%B %d,
          %Y at %I:%M %p') }}
        </div>
      </div>
      {% if current_user.is_authenticated and (current_user.id ==
      response.user_id or current_user.id ==
      response.statement.discussion.creator_id) %}
      <div class="flex space-x-2">
        {% if current_user.id == response.user_id %}
        <a
          href="{{ url_for('statements.edit_response', response_id=response.id) }}"
          class="text-blue-600 hover:underline text-sm"
          >Edit</a
        >
        {% endif %}
        <form
          method="POST"
          action="{{ url_for('statements.delete_response', response_id=response.id) }}"
          class="inline"
        >
          <button
            type="submit"
            class="text-red-600 hover:underline text-sm"
            onclick="return confirm('Delete this response?')"
          >
            Delete
          </button>
        </form>
      </div>
      {% endif %}
    </div>

    <div class="text-lg text-gray-900 mb-4">{{ response.content }}</div>

    <!-- Evidence -->
    {% if response.evidence %}
    <div class="border-t pt-4 mt-4">
      <h4 class="font-semibold text-gray-700 mb-2">Evidence:</h4>
      {% for ev in response.evidence %}
      <div class="bg-gray-50 rounded p-3 mb-2">
        {% if ev.source_title %}
        <div class="font-medium">{{ ev.source_title }}</div>
        {% endif %} {% if ev.source_url %}
        <a
          href="{{ ev.source_url }}"
          target="_blank"
          class="text-blue-600 hover:underline text-sm"
          >{{ ev.source_url }}</a
        >
        {% endif %} {% if ev.citation %}
        <div class="text-gray-700 text-sm mt-1">{{ ev.citation }}</div>
        {% endif %} {% if ev.storage_key %}
        <a
          href="{{ url_for('statements.download_evidence', evidence_id=ev.id) }}"
          class="text-blue-600 hover:underline text-sm"
          >Download attachment</a
        >
        {% endif %}
        <span
          class="inline-block mt-2 px-2 py-1 rounded text-xs {% if ev.quality_status == 'verified' %}bg-green-100 text-green-800 {% elif ev.quality_status == 'disputed' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-600{% endif %}"
        >
          {{ ev.quality_status|upper }}
        </span>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <!-- Child Responses -->
  {% if children %}
  <div class="mb-6">
    <h3 class="text-xl font-semibold mb-4">Replies ({{ children|length }}):</h3>
    {% for child in children %}
    <div
      class="bg-white rounded-lg shadow p-4 mb-3 ml-6 border-l-4 border-blue-300"
    >
      <div class="flex items-start justify-between mb-2">
        <span
          class="inline-block px-2 py-1 rounded-full text-xs font-semibold {% if child.position == 'pro' %}bg-green-100 text-green-800 {% elif child.position == 'con' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-800{% endif %}"
        >
          {{ child.position|upper if child.position else 'Comment' }}
        </span>
        <span class="text-gray-600 text-xs"
          >{{ child.user.name }} · {{ child.created_at.strftime('%b %d')
          }}</span
        >
      </div>
      <div class="text-gray-800">{{ child.content }}</div>
      <a
        href="{{ url_for('statements.view_response', response_id=child.id) }}"
        class="text-blue-600 hover:underline text-sm mt-2 inline-block"
        >View thread</a
      >
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Add Reply Form -->
  {% if current_user.is_authenticated %}
  <div class="bg-white rounded-lg shadow p-6">
    <h3 class="text-lg font-semibold mb-4">Add a Reply</h3>
    <form
      method="POST"
      action="{{ url_for('statements.create_response', statement_id=response.statement_id) }}"
    >
      <input
        type="hidden"
        name="parent_response_id"
        value="{{ response.id }}"
      />
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

      <div class="mb-4">
        <label class="block text-gray-700 mb-2">Position</label>
        <select
          name="position"
          class="w-full border border-gray-300 rounded px-3 py-2"
          required
        >
          <option value="pro">Pro (Supporting)</option>
          <option value="con">Con (Opposing)</option>
          <option value="neutral">Neutral (Commentary)</option>
        </select>
      </div>

      <div class="mb-4">
        <label class="block text-gray-700 mb-2">Your Response</label>
        <textarea
          name="content"
          rows="4"
          class="w-full border border-gray-300 rounded px-3 py-2"
          required
        ></textarea>
      </div>

      <button
        type="submit"
        class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
      >
        Post Reply
      </button>
    </form>
  </div>
  {% else %}
  <div class="bg-gray-50 rounded-lg p-6 text-center">
    <p class="text-gray-600 mb-3">Please log in to reply to this response.</p>
    <a href="{{ url_for('auth.login') }}" class="text-blue-600 hover:underline"
      >Log In</a
    >
  </div>
  {% endif %}
</div>
{% endblock %}
