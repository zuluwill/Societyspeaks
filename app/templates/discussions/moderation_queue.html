{% extends 'layout.html' %} {% block title %}Moderation Queue - {{
discussion.title }}{% endblock %} {% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="mb-6">
    <h1 class="text-3xl font-bold mb-2">Moderation Queue</h1>
    <p class="text-gray-600">{{ discussion.title }}</p>
  </div>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
      <div class="text-yellow-800 text-sm font-semibold">Pending Flags</div>
      <div class="text-3xl font-bold text-yellow-900">{{ stats.pending }}</div>
    </div>
    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
      <div class="text-green-800 text-sm font-semibold">Approved</div>
      <div class="text-3xl font-bold text-green-900">{{ stats.approved }}</div>
    </div>
    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
      <div class="text-blue-800 text-sm font-semibold">Rejected</div>
      <div class="text-3xl font-bold text-blue-900">{{ stats.rejected }}</div>
    </div>
    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
      <div class="text-gray-800 text-sm font-semibold">Total Statements</div>
      <div class="text-3xl font-bold text-gray-900">
        {{ stats.total_statements }}
      </div>
    </div>
  </div>

  <!-- Flags by Reason -->
  {% if flags_by_reason %}
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Flags by Reason</h2>
    <div class="flex flex-wrap gap-2">
      {% for reason, count in flags_by_reason.items() %}
      <span class="bg-gray-100 px-3 py-1 rounded">
        {{ reason }}: <strong>{{ count }}</strong>
      </span>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Pending Flags -->
  {% if pending_flags %}
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">
      Pending Flags ({{ pending_flags|length }})
    </h2>

    <form
      method="POST"
      action="{{ url_for('moderation.bulk_moderation_action', discussion_id=discussion.id) }}"
      id="bulkForm"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="mb-4 flex space-x-2">
        <button
          type="button"
          onclick="selectAll()"
          class="text-sm text-blue-600 hover:underline"
        >
          Select All
        </button>
        <button
          type="button"
          onclick="selectNone()"
          class="text-sm text-blue-600 hover:underline"
        >
          Select None
        </button>
      </div>

      {% for flag in pending_flags %}
      <div class="border rounded-lg p-4 mb-4">
        <div class="flex items-start">
          <input
            type="checkbox"
            name="flag_ids"
            value="{{ flag.id }}"
            class="mt-1 mr-4"
          />
          <div class="flex-1">
            <!-- Statement Content -->
            <div class="bg-gray-50 p-3 rounded mb-3">
              <div class="text-sm text-gray-600 mb-1">
                Statement by {% if flag.statement.user %}{{
                flag.statement.user.username }}{% else %}Anonymous{% endif %}:
              </div>
              <div class="text-gray-900">{{ flag.statement.content }}</div>
              <div class="text-sm text-gray-500 mt-2">
                {{ flag.statement.vote_count_agree }} agree · {{
                flag.statement.vote_count_disagree }} disagree · {{
                flag.statement.vote_count_unsure }} unsure
              </div>
            </div>

            <!-- Flag Details -->
            <div class="mb-3">
              <span
                class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded text-sm font-semibold mr-2"
              >
                {{ flag.flag_reason }}
              </span>
              <span class="text-gray-600 text-sm">
                Flagged by {% if flag.flagger_user %}{{
                flag.flagger_user.username }}{% else %}Unknown{% endif %} on {{
                flag.created_at.strftime('%b %d, %Y') }}
              </span>
            </div>

            {% if flag.additional_context %}
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-3">
              <div class="text-sm font-semibold text-yellow-800 mb-1">
                Context:
              </div>
              <div class="text-gray-700">{{ flag.additional_context }}</div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="flex space-x-2">
              <form
                method="POST"
                action="{{ url_for('moderation.review_flag', discussion_id=discussion.id, flag_id=flag.id) }}"
                class="inline"
              >
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <input type="hidden" name="action" value="approve" />
                <button
                  type="submit"
                  class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm"
                >
                  Approve Flag & Hide Statement
                </button>
              </form>
              <form
                method="POST"
                action="{{ url_for('moderation.review_flag', discussion_id=discussion.id, flag_id=flag.id) }}"
                class="inline"
              >
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <input type="hidden" name="action" value="reject" />
                <button
                  type="submit"
                  class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm"
                >
                  Reject Flag & Keep Statement
                </button>
              </form>
              <a
                href="{{ url_for('statements.view_statement', statement_id=flag.statement_id) }}"
                class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 text-sm"
              >
                View Full Statement
              </a>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}

      <!-- Bulk Actions -->
      <div class="bg-gray-50 p-4 rounded-lg mt-6">
        <h3 class="font-semibold mb-3">Bulk Actions</h3>
        <div class="flex space-x-2">
          <button
            type="submit"
            name="action"
            value="approve_all"
            class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
          >
            Approve All Selected
          </button>
          <button
            type="submit"
            name="action"
            value="reject_all"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
          >
            Reject All Selected
          </button>
        </div>
      </div>
    </form>
  </div>
  {% else %}
  <div class="bg-green-50 rounded-lg p-8 text-center">
    <svg
      class="mx-auto h-12 w-12 text-green-600 mb-4"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <h3 class="text-xl font-semibold text-green-900 mb-2">No Pending Flags</h3>
    <p class="text-green-700">
      Your discussion is clean! All flags have been reviewed.
    </p>
  </div>
  {% endif %}

  <!-- Back to Discussion -->
  <div class="mt-8">
    <a
      href="{{ url_for('discussions.view_discussion', discussion_id=discussion.id, slug=discussion.slug) }}"
      class="text-blue-600 hover:underline"
    >
      ← Back to Discussion
    </a>
  </div>
</div>

<script>
  function selectAll() {
    document
      .querySelectorAll('input[name="flag_ids"]')
      .forEach((cb) => (cb.checked = true));
  }

  function selectNone() {
    document
      .querySelectorAll('input[name="flag_ids"]')
      .forEach((cb) => (cb.checked = false));
  }
</script>
{% endblock %}
