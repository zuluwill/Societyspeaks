{% extends 'layout.html' %}
{% block title %}Consensus Report - {{ discussion.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 {% if for_print %}print:p-0{% endif %}">
  <div class="mb-6 flex justify-between items-start">
    <div>
      <h1 class="text-3xl font-bold mb-2">Consensus Report</h1>
      <p class="text-gray-600">{{ discussion.title }}</p>
    </div>
    <div class="flex gap-2 print:hidden">
      <button onclick="window.print()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 flex items-center">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
        </svg>
        Print
      </button>
      <a href="{{ url_for('consensus.view_results', discussion_id=discussion.id) }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Back to Analysis
      </a>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Report Summary</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
      <div class="text-center p-3 bg-gray-50 rounded">
        <div class="text-2xl font-bold text-blue-600">{{ analysis.num_clusters }}</div>
        <div class="text-sm text-gray-600">Opinion Groups</div>
      </div>
      <div class="text-center p-3 bg-gray-50 rounded">
        <div class="text-2xl font-bold">{{ analysis.participants_count }}</div>
        <div class="text-sm text-gray-600">Participants</div>
      </div>
      <div class="text-center p-3 bg-gray-50 rounded">
        <div class="text-2xl font-bold">{{ analysis.statements_count }}</div>
        <div class="text-sm text-gray-600">Statements</div>
      </div>
      <div class="text-center p-3 bg-gray-50 rounded">
        <div class="text-2xl font-bold {% if analysis.silhouette_score > 0.5 %}text-green-600{% elif analysis.silhouette_score > 0.3 %}text-yellow-600{% else %}text-red-600{% endif %}">{{ "%.2f"|format(analysis.silhouette_score) }}</div>
        <div class="text-sm text-gray-600">Cluster Quality</div>
      </div>
    </div>
    <p class="text-sm text-gray-500">Generated: {{ analysis.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
  </div>

  {% if analysis.cluster_data.get('ai_summary') %}
  <div class="bg-purple-50 rounded-lg shadow p-6 mb-6 border border-purple-200">
    <h2 class="text-xl font-semibold mb-3 text-purple-900">AI Summary</h2>
    <div class="text-gray-800 leading-relaxed">{{ analysis.cluster_data.ai_summary }}</div>
  </div>
  {% endif %}

  {% if consensus_statements %}
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4 text-green-700">Areas of Consensus</h2>
    <p class="text-gray-600 mb-4">Statements where most participants agree, regardless of their opinion group.</p>
    <div class="space-y-3">
      {% for stmt in consensus_statements %}
      <div class="p-4 bg-green-50 rounded-lg border border-green-200">
        <p class="text-gray-800">{{ stmt.content | e }}</p>
        {% set stmt_data = analysis.cluster_data.get('consensus_statements', []) | selectattr('statement_id', 'equalto', stmt.id) | first %}
        {% if stmt_data %}
        <div class="mt-2 text-sm text-green-700">
          {{ "%.0f"|format(stmt_data.get('agreement_rate', 0) * 100) }}% agreement
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {% if bridge_statements %}
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4 text-blue-700">Bridge Statements</h2>
    <p class="text-gray-600 mb-4">Statements that find common ground between different opinion groups.</p>
    <div class="space-y-3">
      {% for stmt in bridge_statements %}
      <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
        <p class="text-gray-800">{{ stmt.content | e }}</p>
        {% set stmt_data = analysis.cluster_data.get('bridge_statements', []) | selectattr('statement_id', 'equalto', stmt.id) | first %}
        {% if stmt_data %}
        <div class="mt-2 text-sm text-blue-700">
          Bridge score: {{ "%.2f"|format(stmt_data.get('bridge_score', 0)) }}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {% if divisive_statements %}
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4 text-red-700">Points of Division</h2>
    <p class="text-gray-600 mb-4">Statements where opinion groups disagree most strongly.</p>
    <div class="space-y-3">
      {% for stmt in divisive_statements %}
      <div class="p-4 bg-red-50 rounded-lg border border-red-200">
        <p class="text-gray-800">{{ stmt.content | e }}</p>
        {% set stmt_data = analysis.cluster_data.get('divisive_statements', []) | selectattr('statement_id', 'equalto', stmt.id) | first %}
        {% if stmt_data %}
        <div class="mt-2 text-sm text-red-700">
          Division score: {{ "%.2f"|format(stmt_data.get('division_score', 0)) }}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {% if not consensus_statements and not bridge_statements and not divisive_statements %}
  <div class="bg-yellow-50 rounded-lg shadow p-6 mb-6 border border-yellow-200">
    <h2 class="text-xl font-semibold mb-2 text-yellow-800">No Statement Analysis Available</h2>
    <p class="text-gray-700">This analysis doesn't have detailed statement breakdowns. Try re-running the analysis to generate fresh data.</p>
  </div>
  {% endif %}

  <div class="bg-gray-50 rounded-lg p-6 text-center text-sm text-gray-500 print:mt-8">
    <p>Report generated by Society Speaks</p>
    <p>{{ discussion.title }} - {{ analysis.created_at.strftime('%B %d, %Y') }}</p>
  </div>
</div>

<style>
@media print {
  .print\:hidden { display: none !important; }
  .print\:p-0 { padding: 0 !important; }
  .print\:mt-8 { margin-top: 2rem !important; }
  body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}
</style>
{% endblock %}
