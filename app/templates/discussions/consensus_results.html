{% extends 'layout.html' %} {% block title %}Consensus Analysis - {{
discussion.title }}{% endblock %} {% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="mb-6">
    <h1 class="text-3xl font-bold mb-2">Consensus Analysis</h1>
    <p class="text-gray-600">{{ discussion.title }}</p>
  </div>

  <!-- Analysis Metadata -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <div class="text-gray-600 text-sm">Opinion Groups</div>
        <div class="text-3xl font-bold text-blue-600">
          {{ analysis.num_clusters }}
        </div>
      </div>
      <div>
        <div class="text-gray-600 text-sm">Participants</div>
        <div class="text-3xl font-bold">{{ analysis.participants_count }}</div>
      </div>
      <div>
        <div class="text-gray-600 text-sm">Statements</div>
        <div class="text-3xl font-bold">{{ analysis.statements_count }}</div>
      </div>
      <div>
        <div class="text-gray-600 text-sm">Cluster Quality</div>
        <div
          class="text-3xl font-bold {% if analysis.silhouette_score > 0.5 %}text-green-600{% elif analysis.silhouette_score > 0.3 %}text-yellow-600{% else %}text-red-600{% endif %}"
        >
          {{ "%.2f"|format(analysis.silhouette_score) }}
        </div>
        <div class="text-xs text-gray-500">Silhouette Score</div>
      </div>
    </div>
    <div class="mt-4 text-sm text-gray-500">
      Analyzed: {{ analysis.created_at.strftime('%B %d, %Y at %I:%M %p') }}
    </div>
  </div>

  <!-- AI Summary (if available) -->
  {% if analysis.cluster_data.get('ai_summary') %}
  <div
    class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg shadow p-6 mb-6 border border-purple-200"
  >
    <div class="flex items-center mb-3">
      <svg
        class="h-6 w-6 text-purple-600 mr-2"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M13 10V3L4 14h7v7l9-11h-7z"
        />
      </svg>
      <h2 class="text-xl font-semibold text-purple-900">AI Summary</h2>
    </div>
    <div class="text-gray-800 leading-relaxed">
      {{ analysis.cluster_data.ai_summary }}
    </div>
  </div>
  {% else %} {% if current_user.is_authenticated and current_user.id ==
  discussion.creator_id %}
  <div class="bg-blue-50 rounded-lg p-6 mb-6 border border-blue-200">
    <h3 class="font-semibold text-blue-900 mb-2">
      üí° Optional: Generate AI Summary
    </h3>
    <p class="text-blue-800 mb-3">
      Get a human-readable summary of this analysis using AI. Requires an API
      key (free to add in settings).
    </p>
    <form
      method="POST"
      action="{{ url_for('consensus.generate_summary', discussion_id=discussion.id) }}"
    >
      <button
        type="submit"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >
        Generate AI Summary
      </button>
      <a
        href="{{ url_for('api_keys.add_api_key') }}"
        class="ml-3 text-blue-600 hover:underline"
        >Add API Key</a
      >
    </form>
  </div>
  {% endif %} {% endif %}

  <!-- Cluster Visualization -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Opinion Groups Visualization</h2>
    <div class="bg-gray-50 rounded-lg p-4">
      <canvas id="clusterChart" width="800" height="500"></canvas>
    </div>
    <div class="mt-4 text-sm text-gray-600">
      <p class="mb-2"><strong>How to read this chart:</strong></p>
      <ul class="list-disc list-inside space-y-1">
        <li>Each dot represents a participant</li>
        <li>Colors show different opinion groups</li>
        <li>Closer dots = more similar voting patterns</li>
        <li>Hover over dots to see participant details</li>
      </ul>
    </div>
  </div>

  <!-- Consensus Statements -->
  {% if consensus_statements %}
  <div class="bg-green-50 rounded-lg shadow p-6 mb-6 border border-green-200">
    <h2 class="text-xl font-semibold text-green-900 mb-4">
      üü¢ Areas of Consensus ({{ consensus_statements|length }})
    </h2>
    <p class="text-green-800 mb-4">
      These statements have broad agreement across all opinion groups.
    </p>
    {% for statement in consensus_statements %}
    <div class="bg-white rounded-lg p-4 mb-3 border-l-4 border-green-500">
      <div class="text-gray-900 mb-2">{{ statement.content }}</div>
      <div class="text-sm text-gray-600">
        {{ statement.vote_count_agree }} agree ¬∑ {{
        statement.vote_count_disagree }} disagree ¬∑ {{
        statement.vote_count_unsure }} unsure
        <span class="ml-3 text-green-700 font-semibold"
          >{{ "%.0f"|format(statement.agreement_rate * 100) }}% agreement</span
        >
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Bridge Statements -->
  {% if bridge_statements %}
  <div class="bg-yellow-50 rounded-lg shadow p-6 mb-6 border border-yellow-200">
    <h2 class="text-xl font-semibold text-yellow-900 mb-4">
      üü° Bridge Statements ({{ bridge_statements|length }})
    </h2>
    <p class="text-yellow-800 mb-4">
      These statements unite different opinion groups and offer common ground.
    </p>
    {% for statement in bridge_statements %}
    <div class="bg-white rounded-lg p-4 mb-3 border-l-4 border-yellow-500">
      <div class="text-gray-900 mb-2">{{ statement.content }}</div>
      <div class="text-sm text-gray-600">
        {{ statement.vote_count_agree }} agree ¬∑ {{
        statement.vote_count_disagree }} disagree ¬∑ {{
        statement.vote_count_unsure }} unsure
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Divisive Statements -->
  {% if divisive_statements %}
  <div class="bg-red-50 rounded-lg shadow p-6 mb-6 border border-red-200">
    <h2 class="text-xl font-semibold text-red-900 mb-4">
      üî¥ Points of Division ({{ divisive_statements|length }})
    </h2>
    <p class="text-red-800 mb-4">
      These statements show significant disagreement between opinion groups.
    </p>
    {% for statement in divisive_statements %}
    <div class="bg-white rounded-lg p-4 mb-3 border-l-4 border-red-500">
      <div class="text-gray-900 mb-2">{{ statement.content }}</div>
      <div class="text-sm text-gray-600">
        {{ statement.vote_count_agree }} agree ¬∑ {{
        statement.vote_count_disagree }} disagree ¬∑ {{
        statement.vote_count_unsure }} unsure
        <span class="ml-3 text-red-700 font-semibold"
          >{{ "%.0f"|format(statement.controversy_score * 100) }}%
          controversy</span
        >
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Actions -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Export & Share</h2>
    <div class="flex space-x-4">
      <a
        href="{{ url_for('consensus.export_analysis', discussion_id=discussion.id, format='json') }}"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >
        Download JSON
      </a>
      <a
        href="{{ url_for('consensus.generate_report', discussion_id=discussion.id) }}"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
      >
        Generate Report
      </a>
      {% if current_user.is_authenticated and current_user.id ==
      discussion.creator_id %}
      <form
        method="POST"
        action="{{ url_for('consensus.trigger_analysis', discussion_id=discussion.id) }}"
        class="inline"
      >
        <button
          type="submit"
          class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
        >
          Re-run Analysis
        </button>
      </form>
      {% endif %}
    </div>
  </div>

  <!-- Methodology -->
  <div class="bg-gray-50 rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold mb-3">üìä Methodology</h2>
    <div class="text-gray-700 space-y-2 text-sm">
      <p>
        <strong>Clustering Method:</strong> {{ analysis.method.title() }}
        clustering with PCA dimensionality reduction
      </p>
      <p>
        <strong>Consensus Criteria:</strong> ‚â•70% overall agreement AND ‚â•60%
        agreement in each opinion group
      </p>
      <p>
        <strong>Bridge Criteria:</strong> High mean agreement (‚â•65%) with low
        variance (<0.15) across groups
      </p>
      <p>
        <strong>Divisive Criteria:</strong> Controversy score ‚â•0.7 (close to
        50/50 split)
      </p>
      <p>
        <strong>Silhouette Score:</strong> Measures cluster quality (>0.5 =
        good, 0.3-0.5 = fair, <0.3 = weak)
      </p>
    </div>
  </div>

  <!-- Back to Discussion -->
  <div class="mt-8">
    <a
      href="{{ url_for('discussions.view_discussion', discussion_id=discussion.id, slug=discussion.slug) }}"
      class="text-blue-600 hover:underline"
    >
      ‚Üê Back to Discussion
    </a>
  </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Cluster Visualization Script -->
<script>
  document.addEventListener("DOMContentLoaded", async function () {
    const canvas = document.getElementById("clusterChart");
    if (!canvas) return;

    try {
      // Fetch cluster data from API
      const response = await fetch(
        '{{ url_for("consensus.get_cluster_data", discussion_id=discussion.id) }}'
      );
      const data = await response.json();

      if (data.error) {
        console.error("Error loading cluster data:", data.error);
        return;
      }

      const clusterAssignments = data.cluster_assignments;
      const pcaCoordinates = data.pca_coordinates;
      const metadata = data.metadata;

      // Prepare data for Chart.js
      const colors = [
        "rgba(59, 130, 246, 0.8)", // Blue
        "rgba(239, 68, 68, 0.8)", // Red
        "rgba(34, 197, 94, 0.8)", // Green
        "rgba(251, 146, 60, 0.8)", // Orange
        "rgba(168, 85, 247, 0.8)", // Purple
        "rgba(236, 72, 153, 0.8)", // Pink
        "rgba(14, 165, 233, 0.8)", // Cyan
        "rgba(234, 179, 8, 0.8)", // Yellow
      ];

      // Group users by cluster
      const clusters = {};
      for (const [userId, clusterId] of Object.entries(clusterAssignments)) {
        if (!clusters[clusterId]) {
          clusters[clusterId] = [];
        }
        const coords = pcaCoordinates[userId];
        if (coords) {
          clusters[clusterId].push({
            x: coords[0],
            y: coords[1],
            userId: userId,
          });
        }
      }

      // Create datasets for each cluster
      const datasets = Object.keys(clusters)
        .sort()
        .map((clusterId, index) => {
          const clusterNum = parseInt(clusterId);
          return {
            label: `Group ${clusterNum + 1}`,
            data: clusters[clusterId],
            backgroundColor: colors[clusterNum % colors.length],
            borderColor: colors[clusterNum % colors.length].replace("0.8", "1"),
            borderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
          };
        });

      // Create chart
      new Chart(canvas, {
        type: "scatter",
        data: {
          datasets: datasets,
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            title: {
              display: true,
              text: `${metadata.num_clusters} Opinion Groups (${metadata.participants_count} participants)`,
              font: {
                size: 16,
                weight: "bold",
              },
            },
            legend: {
              display: true,
              position: "top",
              labels: {
                font: {
                  size: 12,
                },
                padding: 15,
                usePointStyle: true,
              },
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  return [
                    `Group ${context.datasetIndex + 1}`,
                    `User ID: ${context.raw.userId}`,
                    `Position: (${context.raw.x.toFixed(
                      2
                    )}, ${context.raw.y.toFixed(2)})`,
                  ];
                },
              },
            },
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "Principal Component 1",
                font: {
                  size: 14,
                },
              },
              grid: {
                color: "rgba(0, 0, 0, 0.05)",
              },
            },
            y: {
              title: {
                display: true,
                text: "Principal Component 2",
                font: {
                  size: 14,
                },
              },
              grid: {
                color: "rgba(0, 0, 0, 0.05)",
              },
            },
          },
          interaction: {
            mode: "point",
            intersect: true,
          },
        },
      });
    } catch (error) {
      console.error("Error rendering cluster visualization:", error);
      canvas.parentElement.innerHTML = `
            <div class="text-center py-8">
                <p class="text-red-600">Error loading visualization</p>
                <p class="text-sm text-gray-500 mt-2">${error.message}</p>
            </div>
        `;
    }
  });
</script>

{% endblock %}
